# LearnSphere AI 权限和限制系统完善总结

## 📅 更新时间
2026-01-19

## 🎯 更新目标
完善普通用户和会员用户的权限和限制系统，明确不同用户类型的功能访问权限和AI配额限制。

---

## ✅ 完成的工作

### 1. 后端权限系统增强

#### 1.1 VIP权限检查逻辑优化
**文件**: `backend/src/main/java/com/learnsphere/common/aspect/VipCheckAspect.java`

**主要改进**:
- ✅ 为普通用户提供**每日5次免费AI配额**
- ✅ VIP用户根据等级享受不同配额：
  - 月度会员（等级1）: 50次/天
  - 季度会员（等级2）: 100次/天
  - 年度会员（等级3）: 200次/天
- ✅ 改进配额耗尽提示，普通用户会收到升级引导
- ✅ 添加详细的日志记录功能调用情况

**关键代码逻辑**:
```java
// 根据用户VIP等级确定每日配额
if (isVip) {
    // VIP用户：50-200次/天
    switch (userVipLevel) {
        case 1: dailyQuota = 50; break;
        case 2: dailyQuota = 100; break;
        case 3: dailyQuota = 200; break;
    }
} else {
    // 普通用户：5次/天免费额度
    dailyQuota = 5;
}
```

#### 1.2 用户配额查询接口增强
**文件**: `backend/src/main/java/com/learnsphere/controller/UserController.java`

**新增功能**:
- ✅ 返回用户VIP状态和等级
- ✅ 计算配额使用百分比
- ✅ 显示剩余配额
- ✅ 区分普通用户和VIP用户的配额显示

**API响应示例**:
```json
{
  "dailyQuota": 5,          // 每日总配额
  "usedToday": 3,           // 今日已用
  "remainingToday": 2,      // 今日剩余
  "usagePercent": 60.0,     // 使用百分比
  "isVip": false,           // 是否VIP
  "vipLevel": 0             // VIP等级
}
```

#### 1.3 模拟考试权限调整
**文件**: `backend/src/main/java/com/learnsphere/controller/MockExamController.java`

**改进**:
- ✅ 设置 `minLevel = 0`，允许普通用户也能生成模拟考试
- ✅ 模拟考试消耗2次配额（比普通AI生成更高）
- ✅ 普通用户每日最多生成2套模拟考试（5次配额 ÷ 2）

---

### 2. 前端权限系统完善

#### 2.1 VIP权限管理 Composable
**文件**: `frontend-vue/src/composables/useVipPermission.js`

**提供功能**:
- ✅ `checkPermission()` - 检查是否有VIP权限
- ✅ `checkQuota()` - 检查配额是否足够
- ✅ `showUpgradeDialog()` - 显示升级对话框
- ✅ `fetchQuotaInfo()` - 获取配额信息
- ✅ `showQuotaWarning()` - 显示配额预警

**使用示例**:
```javascript
const { isVip, checkQuota, showUpgradeDialog } = useVipPermission()

// 在调用AI功能前检查
const handleGenerate = async () => {
  if (!await checkQuota(1)) {
    return  // 配额不足，已自动显示提示
  }
  // 继续执行AI生成...
}
```

#### 2.2 VIP升级提示组件
**文件**: `frontend-vue/src/components/VipUpgrade Prompt.vue`

**功能**:
- ✅ 美观的升级引导UI
- ✅ 可配置标题、描述和按钮文本
- ✅ 可显示VIP特权列表
- ✅ 支持紧凑模式（compact）
- ✅ 响应式设计，适配移动端

#### 2.3 配额显示组件
**文件**: `frontend-vue/src/components/QuotaDisplay.vue`

**功能**:
- ✅ 实时显示今日配额使用情况
- ✅ 悬停显示详细信息（Popover）
- ✅ 使用进度条可视化配额消耗
- ✅ 配额不足时颜色警告（绿→黄→红）
- ✅ VIP和普通用户不同样式
- ✅ 每5分钟自动刷新配额数据

#### 2.4 导航栏集成
**文件**: `frontend-vue/src/layouts/MainLayout.vue`

**改进**:
- ✅ 在顶部导航栏添加配额显示组件
- ✅ PC端显示完整配额信息
- ✅ 移动端隐藏（节省空间）

#### 2.5 个人中心VIP权益展示增强
**文件**: `frontend-vue/src/views/ProfileView.vue`

**VIP用户页面展示**:
- ✅ 会员类型和到期时间
- ✅ 今日配额使用进度条
- ✅ 每日配额、到期时间、剩余天数
- ✅ 专属特权列表（6项特权）
- ✅ 续费按钮引导

**普通用户页面展示**:
- ✅ 免费额度使用情况
- ✅ 可用功能列表（词汇学习、测试等）
- ✅ VIP专属功能列表（已锁定）
- ✅ 三种会员方案对比
- ✅ 升级按钮引导

---

### 3. 文档完善

#### 3.1 用户权限说明文档
**文件**: `docs/USER_PERMISSIONS.md`

**内容包括**:
- ✅ 用户类型定义（普通/月度/季度/年度）
- ✅ 功能权限对比表
- ✅ 基础功能列表（所有用户可用）
- ✅ AI增强功能列表（VIP专属）
- ✅ VIP专属特权（7大特权）
- ✅ 限制说明
- ✅ 升级建议
- ✅ 推荐活动机制
- ✅ 配额查询位置

---

## 📊 权限对比总览

### 普通用户 vs VIP用户

| 功能类别 | 普通用户 | 月度VIP | 季度VIP | 年度VIP |
|---------|---------|---------|---------|---------|
| **每日AI配额** | 5次 | 50次 | 100次 | 200次 |
| **价格** | 免费 | ¥10/月 | ¥25/季 | ¥88/年 |
| **词汇学习** | ✅ | ✅ | ✅ | ✅ |
| **词汇测试** | ✅ | ✅ | ✅ | ✅ |
| **学习记录** | ✅ | ✅ | ✅ | ✅ |
| **AI阅读生成** | ❌ | ✅ | ✅ | ✅ |
| **AI写作批改** | ❌ | ✅ | ✅ | ✅ |
| **AI听力生成** | ❌ | ✅ | ✅ | ✅ |
| **AI语法练习** | ❌ | ✅ | ✅ | ✅ |
| **AI口语评测** | ❌ | ✅ | ✅ | ✅ |
| **模拟考试** | 有限 | 充足 | 充足 | 充足 |
| **无广告** | ❌ | ✅ | ✅ | ✅ |
| **优先客服** | ❌ | ✅ | ✅ | ✅ |

---

## 🔧 技术实现细节

### 配额管理机制
- **存储**: Redis（按日期键存储）
- **键格式**: `quota:user:{userId}:{date}`
- **过期**: 1天自动过期
- **重置**: 每日0点自动重置

### VIP状态判断逻辑
```java
boolean isVip = vipExpireTime != null && 
                vipExpireTime.isAfter(LocalDateTime.now());
```

### 配额消耗规则
| 功能 | 消耗配额 |
|-----|---------|
| AI阅读生成 | 1次 |
| AI听力生成 | 1次 |
| AI语法生成 | 1次 |
| AI口语话题 | 1次 |
| AI写作题目 | 1次 |
| AI写作批改 | 2次 |
| AI口语评测 | 2次 |
| 模拟考试 | 2次 |

---

## 🎨 UI/UX 改进

### 1. 导航栏配额显示
- 实时显示剩余配额
- 颜色编码（绿色→黄色→红色）
- Popover详细信息
- 升级引导按钮

### 2. 个人中心VIP展示
- 渐变背景卡片
- 进度条可视化
- 特权列表网格布局
- 对比式设计（VIP vs 普通）

### 3. 升级引导体验
- 统一的对话框样式
- 清晰的价值主张
- 多处升级入口
- 价格对比展示

---

## 📱 响应式适配

### 移动端优化
- ✅ 导航栏配额组件在移动端隐藏
- ✅ 个人中心VIP卡片栅格自适应
- ✅ 升级提示对话框移动端友好
- ✅ 价格卡片垂直堆叠

---

## 🚀 后续建议

### 短期优化（1-2周）
1. **添加配额预警提醒**
   - 配额低于20%时弹toast提示
   - 配额耗尽前一天邮件提醒

2. **优化升级转化**
   - A/B测试不同的升级话术
   - 添加限时优惠提示

3. **增加免费获取配额途径**
   - 每日签到奖励
   - 邀请好友奖励
   - 完成任务奖励

### 中期规划（1-2月）
1. **推出团队VIP**
   - 企业批量购买
   - 统一管理后台

2. **引入积分系统**
   - 积分兑换配额
   - 积分兑换VIP天数

3. **更细粒度的权限控制**
   - 按功能单独购买
   - 临时提升配额

### 长期愿景（3-6月）
1. **AI使用分析**
   - 用户行为分析
   - 功能使用热力图
   - 转化漏斗分析

2. **个性化推荐**
   - 根据使用习惯推荐会员等级
   - 智能配额分配

3. **会员成长体系**
   - VIP等级晋升
   - 长期会员专属福利

---

## 📝 使用指南

### 前端开发者
```vue
<script setup>
import { useVipPermission } from '@/composables/useVipPermission'
import VipUpgradePrompt from '@/components/VipUpgradePrompt.vue'

const { isVip, checkQuota } = useVipPermission()

const handleAIFeature = async () => {
  // 检查VIP权限
  if (!isVip.value) {
    showUpgradeDialog('AI 功能')
    return
  }
  
  // 检查配额
  if (!await checkQuota(2)) {
    return
  }
  
  // 执行AI功能...
}
</script>

<template>
  <!-- 非VIP用户显示升级提示 -->
  <VipUpgradePrompt 
    v-if="!isVip"
    title="此功能需要VIP"
    :features="['每日高额配额', 'AI批改', '无限量生成']"
  />
</template>
```

### 后端开发者
```java
// 在Controller方法上添加注解
@RequireVip(
    feature = "AI 功能名称",
    quotaCost = 1,      // 消耗配额数
    minLevel = 0,       // 0=允许普通用户，1=需要VIP
    checkQuota = true   // 是否检查配额
)
@PostMapping("/generate")
public Result<?> generate(@RequestBody Request req) {
    // 方法体
}
```

---

## ✍️ 作者
LearnSphere AI 开发团队

## 📧 反馈
如有问题或建议，请联系：support@learnsphere.ai
