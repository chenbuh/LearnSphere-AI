# LearnSphere AI 后续优化建议（详实版）

## 1. 统一观测链路

### 目标
打通「前端体验 → 后端接口 → AI 调用」全链路指标，快速定位性能/失败点，提升响应时间、可用率和用户体验。

### 现状
- 前端缺乏统一性能指标沉淀，AI 请求、路由、API 等埋点零散。
- 后端虽有 Actuator，但自定义指标未集中推送到监控系统。
- AI/Redis/DB 出错需依赖日志排查，告警不足。

### 具体措施
1. 前端在 Pinia action、路由守卫、AI 请求前后埋点（耗时、状态、错误码），利用 `window.performance`/`Navigation Timing` 报送首屏、首交互指标。
2. 后端接入 Prometheus + Spring Actuator + Micrometer，自定义计时器覆盖 AI 请求、Redis 命中率、MyBatis 查询耗时；把指标统一暴露给 Grafana。
3. AI 层（gateway/backend）统计调用次数、token 消耗、失败率、Avg latency；对 QPS 使用 token bucket 限流并在失败率/latency 超阈时触发降级。
4. 设定告警策略：响应时间（80% percentile）超 500ms、AI 失败率超 2%、Redis 连接超时/穿透事件等应触发警报。
5. 通过 Grafana Dashboard 呈现全链路数据，并在 docs 里同步指标定义。

### 验收指标
- 前端 `largest-contentful-paint` < 2s，AI 请求 avg latency < 400ms。
- AI failure rate < 2%，Redis cache miss 导致的 DB 查询下降 30%。
- 告警事件可定位到具体服务/接口（例如 `AI/paragraph/stream`）。

### 参考
- docs/性能优化/学习优化.md
- backend/src/main/java/**/Actuator 与 Micrometer 配置
- frontend-vue/src/stores/**/Pinia API 状态

---

## 2. 前端体验与运行时优化

### 目标
保持首屏加载 < 2s、路由切换 < 200ms，确保 AI/音频功能在低网速下也能顺畅使用。

### 现状
- App/主布局一次性加载所有视图，bundle > 3MB。
- AI 模块（FlashCard、Listening）依赖大体积音频，缺乏缓存策略。
- PWA 缓存机制存在，但未完全适配低网速/离线场景。

### 具体措施
1. 路由级懒加载：在 `router/index.js` 使用 `import()` 逐个加载 Vue 视图；在 `vite.config.js` 设置 `manualChunks`，将 AI/数据模块拆出核心 bundle。
2. AI 组件预取：对 FlashCard、LearningPathRecommendation 等预加载资源，避免首次进入时跳帧。
3. Service Worker + CDN：扩展或新增 SW 规则，对 TTS 音频/AI 快照/样张图片使用 Cache First 策略；API 使用 Network First + fallback。
4. Pinia 状态懒初始化与 skeleton：把重数据状态（词汇列表、错题本）延后加载，视图渲染前展示 skeleton/placeholder。
5. 强化 PWA + 主题：完善 `manifest.json`、service worker 缓存策略，结合 `docs/性能优化/移动端适配.md` 的移动主题切换逻辑。

### 验收指标
- Lighthouse Performance > 90，First Contentful Paint < 1.5s。
- AI 视图在 3G 网络下可渲染，PWA 缓存命中率 > 60%。
- 路由加载平均耗时下降 40%，切换界面破绽减少。

### 参考
- docs/性能优化/移动端适配.md
- frontend-vue/vite.config.js、router/index.js、src/service-worker.ts

---

## 3. 后端稳定与数据效率

### 目标
保障学习分析/错题/AI 接口的稳定性，避免 AI/DB 慢查询拖垮服务，将 API 可用率提升至 99.9%。

### 现状
- MyBatis 查询未充分索引，学习分析统计接口聚合量大。
- 默认连接池在高 AI QPS 下易耗尽，部分请求超时。
- AI 接口无降级限流，直接抛出错误影响用户。

### 具体措施
1. SQL/索引优化：针对 `learning_analysis`、`error_book` 等聚合查询进行 `EXPLAIN`，增补复合索引；对频繁调用的数据使用 Redis 缓存（TTL 10 分钟）。
2. Materialized View：缓存错题、热力图等数据定期刷新，避免每次请求扫描大表。
3. 连接池与超时配置：在 `application.yml` 里调整 HikariCP 池大小、idle timeout；为 AI 接口与 MyBatis 设置超时（read timeout 5 秒），避免堆积。
4. AI 接口限流降级：在 gateway/backend 增加 token bucket；当 latency 或失败率高于阈值时返回降级提示/Mock 数据。
5. Sa-Token + 权限日志：增强 AI/学习分析接口的权限埋点便于查错。

### 验收指标
- AI 接口 avg latency < 400ms，95% percentile < 1s。
- 复杂查询响应 < 500ms，Redis 命中率 > 85%。
- 连接池等待时间 < 0.5s，线程池 & CPU 使用稳定。

### 参考
- docs/后端架构/（相关章节）
- backend/src/main/java/**/service + controller
- backend/src/main/resources/application-secret.properties

---

## 4. AI 功能保障与成本控制

### 目标
保障 AI 功能可用性，控制成本，失败率 < 2%，调用成本可追踪。

### 现状
- AI 请求直通 OpenAI/Qwen/Edge，未设 cache/重试。
- TTS/AI 评分成本未监控，异常时前端提示模糊。
- 缺乏 fallback，当 AI 模型出故障，用户体验不连贯。

### 具体措施
1. AI 缓存：对 `prompt + userId` 建立 Redis 快照（TTL 1 分钟），减少重复调用；对评分/听写类可用 mock 结果时先检查缓存。
2. fallback 策略：AI streaming 超时自动终止并展示已有文字；失败后显示“稍后重试”或回退到默认内容，并记录事件。
3. 成本监控：在 docs/AI 功能中列出每个模型（Qwen-Plus、EdgeTTS、Claude）的 `CALL_RATE`、`tokenConsumed`、`costPerRequest`；同时推送 Prometheus 指标并设置预算告警。
4. 多模型治理：统一 error/latency 处理逻辑（gateway/backend）；模型异常时自动 fallback 到备用模型，记录事件。
5. 可见反馈：前端增加“AI 正在处理”+“尝试重试”状态，配合 `docs/AI 功能/` 中的使用说明。

### 验收指标
- AI 失败率 < 2%，失败回退率 < 10%。
- 每日 AI cost 在预算内，可根据 docs 数据看到消耗分布。
- 模型连续失败 3 次自动切换，事件记录在监控面板。

### 参考
- docs/AI功能/（现有拆解）
- gateway/src/main/java/**/AIController
- backend/src/main/java/**/AIBatchService

---

## 5. 流程与质量门控制

### 目标
让每次优化都伴随 lint/test/Docs，不断沉淀能力并形成闭环流程。

### 现状
- CI 依赖手动执行 lint/build/test，缺少规范 hooks。
- AI/权限/前端组件缺集成测试，回归风险高。
- 优化复盘文档不完整，难以复用。

### 具体措施
1. Pre-commit：通过 husky/hooks 触发 `npm run lint`、`npm run test`；前端加 `vue-tsc --noEmit`，后端 `mvn -q test`。
2. CI/CD：编写 GitHub Actions/workflow 脚本串联 `npm install`、`npm run lint`、`npm run build` 与 `mvn test`；`deploy.bat` 前追加构建命令。
3. 优化复盘：每次演进后在 `docs/性能优化/学习优化.md` 或新建 `docs/性能优化/优化回顾.md` 写指标对比与结论。
4. Issue/PR 模板：增加“影响范围”、“测试命令”、“验证步骤”字段，方便 QA/PM 评估。

### 验收指标
- 所有 PR 通过 lint/test，CI 报表完整。
- 每项优化都有 docs 记录（时间 + 指标 + 截图）。
- 部署前 `npm run build`+`mvn test` 无错误，Test coverage 有增长。

### 参考
- docs/开发指南/DEVELOPMENT.md
- frontend-vue/package.json scripts
- backend/pom.xml + maven profile

---

## 成功标准一览

| 指标 | 说明 | 目标值 |
| --- | --- | --- |
| 首屏加载 | Lighthouse FCP | < 1.5s |
| Route 切换 | 单页面导航切换时间 | < 200ms |
| AI 请求 latency | 95% percentile | < 1s |
| AI 失败率 | 失败响应占比 | < 2% |
| Redis 命中率 | 缓存命中统计 | > 85% |
| API 可用率 | 活跃接口 | 99.9% |
| AI cost | 日/周 token 消耗 | 预算内 |
| 文档 & 回顾 | 优化后更新 docs | 覆盖每次改动 |
