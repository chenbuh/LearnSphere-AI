# 🗄️ LearnSphere AI 数据库初始化指南

> 专为宝塔面板优化的数据库初始化文档

---

## 📋 目录

- [方式一：宝塔面板图形界面](#方式一宝塔面板图形界面)（**推荐**）
- [方式二：命令行方式](#方式二命令行方式)
- [方式三：Docker 方式](#方式三docker-方式)
- [配置后端连接](#配置后端连接)
- [数据库备份与恢复](#数据库备份与恢复)
- [常见问题](#常见问题)

---

## 方式一：宝塔面板图形界面

### ✨ **推荐方式** - 最简单直观

### 步骤 1: 登录宝塔面板

```
访问地址: http://你的服务器IP:8888
或: https://你的域名:8888
```

输入宝塔面板的用户名和密码登录。

### 步骤 2: 创建数据库

1. **进入数据库管理**
   - 点击左侧菜单栏的 **"数据库"**
   - 确保已安装 MySQL（如未安装，在"软件商店"中安装 MySQL 8.0）

2. **添加数据库**
   - 点击页面上方的 **"添加数据库"** 按钮
   - 填写以下信息：

   ```
   数据库名称: learnsphere_ai
   用户名: learnsphere
   密码: [设置强密码，例如: LS2026@Secure!]
   访问权限: 本地服务器 (127.0.0.1)
   字符集: utf8mb4
   备注: LearnSphere AI 数据库
   ```

3. **提交创建**
   - 点击 **"提交"** 按钮
   - 等待数据库创建完成（通常几秒钟）

### 步骤 3: 导入数据库结构

#### 方法 A: 使用 phpMyAdmin（推荐）

1. **打开 phpMyAdmin**
   - 在数据库列表中，找到刚创建的 `learnsphere_ai`
   - 点击右侧的 **"管理"** 按钮
   - 会自动打开 phpMyAdmin 并选中该数据库

2. **导入 SQL 文件**
   - 点击顶部菜单栏的 **"导入"** 标签
   - 点击 **"选择文件"** 按钮
   - 选择项目中的 `backend/src/main/resources/schema.sql` 文件
   - 确保格式选择为 **"SQL"**
   - 点击页面底部的 **"执行"** 按钮

3. **等待导入完成**
   - 导入成功后会显示绿色提示信息
   - 如果文件较大，可能需要几秒到几十秒

#### 方法 B: 使用宝塔终端（高级用户）

1. **上传 SQL 文件**
   - 点击 **"文件"** 菜单
   - 进入 `/www/wwwroot/learnsphere/` 目录
   - 上传 `schema.sql` 文件

2. **执行导入命令**
   - 点击 **"终端"** 菜单
   - 执行以下命令：

   ```bash
   mysql -u learnsphere -p learnsphere_ai < /www/wwwroot/learnsphere/schema.sql
   ```

   - 输入数据库密码后回车

### 步骤 4: 验证数据库

1. **查看表结构**
   - 在 phpMyAdmin 中，点击左侧的 `learnsphere_ai` 数据库
   - 应该看到以下表：
     - ✅ `user` (用户表)
     - ✅ `vocabulary` (词汇表)
     - ✅ `grammar_exercise` (语法练习表)
     - ✅ `learning_record` (学习记录表)
     - ✅ `reading_exercise` (阅读练习表)
     - ✅ `listening_exercise` (听力练习表)
     - ✅ `writing_topic` (写作题目表)
     - ✅ `study_plan` (学习计划表)
     - ✅ 以及其他业务表...

2. **检查表数量**
   - 点击任意一个表，查看结构是否正确
   - 确认字符集为 `utf8mb4`

### 步骤 5: 设置自动备份（推荐）

1. **创建计划任务**
   - 点击左侧菜单的 **"计划任务"**
   - 点击 **"添加计划任务"**

2. **配置备份任务**
   ```
   任务类型: 备份数据库
   任务名称: 备份 LearnSphere 数据库
   执行周期: 每天
   执行时间: 02:00 (凌晨2点)
   备份数据库: learnsphere_ai
   保留备份份数: 7 (保留最近7天)
   ```

3. **保存任务**
   - 点击 **"添加"** 按钮
   - 备份文件会保存在 `/www/backup/database/` 目录

---

## 方式二：命令行方式

### 适用场景
- 需要批量操作
- 自动化脚本
- 没有图形界面

### Linux/Mac 系统

```bash
# 1. 登录 MySQL
mysql -u root -p

# 2. 执行创建命令
CREATE DATABASE IF NOT EXISTS learnsphere_ai 
  DEFAULT CHARACTER SET utf8mb4 
  COLLATE utf8mb4_unicode_ci;

CREATE USER IF NOT EXISTS 'learnsphere'@'localhost' 
  IDENTIFIED BY 'LS2026@Secure!';

GRANT ALL PRIVILEGES ON learnsphere_ai.* 
  TO 'learnsphere'@'localhost';

FLUSH PRIVILEGES;
EXIT;

# 3. 导入数据库结构
mysql -u learnsphere -p learnsphere_ai < backend/src/main/resources/schema.sql

# 4. 验证
mysql -u learnsphere -p learnsphere_ai -e "SHOW TABLES;"
```

### Windows 系统

```powershell
# 使用 PowerShell

# 1. 创建数据库
mysql -u root -p -e "CREATE DATABASE IF NOT EXISTS learnsphere_ai DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 2. 创建用户
mysql -u root -p -e "CREATE USER IF NOT EXISTS 'learnsphere'@'localhost' IDENTIFIED BY 'LS2026@Secure!';"

# 3. 授权
mysql -u root -p -e "GRANT ALL PRIVILEGES ON learnsphere_ai.* TO 'learnsphere'@'localhost';"
mysql -u root -p -e "FLUSH PRIVILEGES;"

# 4. 导入结构
Get-Content backend\src\main\resources\schema.sql | mysql -u learnsphere -p learnsphere_ai

# 5. 验证
mysql -u learnsphere -p learnsphere_ai -e "SHOW TABLES;"
```

### 一键脚本（Linux）

创建 `init_database.sh`：

```bash
#!/bin/bash

# 配置
DB_NAME="learnsphere_ai"
DB_USER="learnsphere"
DB_PASS="LS2026@Secure!"
SQL_FILE="backend/src/main/resources/schema.sql"

echo "开始初始化数据库..."

# 创建数据库和用户
mysql -u root -p <<EOF
CREATE DATABASE IF NOT EXISTS ${DB_NAME} DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER IF NOT EXISTS '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASS}';
GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'localhost';
FLUSH PRIVILEGES;
EOF

# 导入结构
mysql -u ${DB_USER} -p${DB_PASS} ${DB_NAME} < ${SQL_FILE}

# 验证
echo "验证数据库表..."
mysql -u ${DB_USER} -p${DB_PASS} ${DB_NAME} -e "SHOW TABLES;"

echo "数据库初始化完成！"
```

使用方式：
```bash
chmod +x init_database.sh
./init_database.sh
```

---

## 方式三：Docker 方式

### 适用场景
- 使用 Docker 部署
- 开发环境快速搭建
- 隔离的数据库环境

### 启动 MySQL 容器

```bash
# 创建并启动 MySQL 容器
docker run -d \
  --name learnsphere-mysql \
  --restart=always \
  -e MYSQL_ROOT_PASSWORD=root_password \
  -e MYSQL_DATABASE=learnsphere_ai \
  -e MYSQL_USER=learnsphere \
  -e MYSQL_PASSWORD=LS2026@Secure! \
  -p 3306:3306 \
  -v learnsphere-mysql-data:/var/lib/mysql \
  mysql:8.0 \
  --character-set-server=utf8mb4 \
  --collation-server=utf8mb4_unicode_ci

# 等待 MySQL 启动（约 30 秒）
echo "等待 MySQL 启动..."
sleep 30

# 导入数据库结构
docker exec -i learnsphere-mysql \
  mysql -ulearnsphere -pLS2026@Secure! learnsphere_ai \
  < backend/src/main/resources/schema.sql

# 验证
docker exec -it learnsphere-mysql \
  mysql -ulearnsphere -pLS2026@Secure! learnsphere_ai \
  -e "SHOW TABLES;"

echo "Docker 数据库初始化完成！"
```

### Docker Compose 方式

创建 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: learnsphere-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: learnsphere_ai
      MYSQL_USER: learnsphere
      MYSQL_PASSWORD: LS2026@Secure!
    ports:
      - "3306:3306"
    volumes:
      - learnsphere-mysql-data:/var/lib/mysql
      - ./backend/src/main/resources/schema.sql:/docker-entrypoint-initdb.d/schema.sql
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci

volumes:
  learnsphere-mysql-data:
```

使用方式：
```bash
# 启动
docker-compose up -d

# 查看日志
docker-compose logs -f mysql

# 停止
docker-compose down
```

---

## 配置后端连接

### 开发环境配置

编辑 `backend/src/main/resources/application-dev.yml`：

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/learnsphere_ai?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai&useSSL=false
    username: learnsphere
    password: LS2026@Secure!
    driver-class-name: com.mysql.cj.jdbc.Driver
```

### 生产环境配置（宝塔部署）

创建 `/www/wwwroot/learnsphere/application.properties`：

```properties
# 数据库配置
spring.datasource.url=jdbc:mysql://localhost:3306/learnsphere_ai?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai&useSSL=false
spring.datasource.username=learnsphere
spring.datasource.password=LS2026@Secure!

# 或使用环境变量（更安全）
# spring.datasource.username=${DB_USERNAME}
# spring.datasource.password=${DB_PASSWORD}
```

### 使用环境变量（推荐）

在启动脚本中设置：

```bash
#!/bin/bash
export DB_USERNAME=learnsphere
export DB_PASSWORD=LS2026@Secure!

java -jar learnsphere-ai-0.0.1-SNAPSHOT.jar
```

---

## 数据库备份与恢复

### 宝塔面板备份

#### 手动备份
1. **数据库** → 找到 `learnsphere_ai`
2. 点击右侧的 **"备份"** 按钮
3. 备份文件保存在 `/www/backup/database/`

#### 自动备份
1. **计划任务** → **添加计划任务**
2. 任务类型: `备份数据库`
3. 选择数据库: `learnsphere_ai`
4. 执行周期: `每天 02:00`
5. 保留份数: `7`

### 命令行备份

```bash
# 完整备份
mysqldump -u learnsphere -p learnsphere_ai > learnsphere_ai_backup_$(date +%Y%m%d_%H%M%S).sql

# 仅备份结构
mysqldump -u learnsphere -p --no-data learnsphere_ai > learnsphere_ai_schema.sql

# 仅备份数据
mysqldump -u learnsphere -p --no-create-info learnsphere_ai > learnsphere_ai_data.sql

# 压缩备份
mysqldump -u learnsphere -p learnsphere_ai | gzip > learnsphere_ai_backup_$(date +%Y%m%d).sql.gz
```

### 恢复数据库

```bash
# 从备份恢复
mysql -u learnsphere -p learnsphere_ai < learnsphere_ai_backup_20260118.sql

# 从压缩备份恢复
gunzip < learnsphere_ai_backup_20260118.sql.gz | mysql -u learnsphere -p learnsphere_ai
```

### 宝塔面板恢复

1. **数据库** → 找到 `learnsphere_ai`
2. 点击 **"管理"** → 进入 phpMyAdmin
3. 点击 **"导入"** 标签
4. 选择备份的 SQL 文件
5. 点击 **"执行"**

---

## 常见问题

### ❓ 问题 1: Access denied for user

**错误信息**:
```
ERROR 1045 (28000): Access denied for user 'learnsphere'@'localhost'
```

**解决方案**:

```sql
-- 检查用户是否存在
SELECT user, host FROM mysql.user WHERE user='learnsphere';

-- 重新创建用户
DROP USER IF EXISTS 'learnsphere'@'localhost';
CREATE USER 'learnsphere'@'localhost' IDENTIFIED BY 'LS2026@Secure!';
GRANT ALL PRIVILEGES ON learnsphere_ai.* TO 'learnsphere'@'localhost';
FLUSH PRIVILEGES;
```

### ❓ 问题 2: 字符集不正确

**检查字符集**:
```sql
SHOW CREATE DATABASE learnsphere_ai;
```

**修改字符集**:
```sql
ALTER DATABASE learnsphere_ai 
  CHARACTER SET utf8mb4 
  COLLATE utf8mb4_unicode_ci;
```

**修改表字符集**:
```sql
ALTER TABLE user CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### ❓ 问题 3: 连接超时

**临时解决**:
```sql
SET GLOBAL connect_timeout=60;
SET GLOBAL wait_timeout=28800;
SET GLOBAL interactive_timeout=28800;
```

**永久解决（宝塔）**:
1. **软件商店** → **MySQL** → **设置**
2. **配置修改** → 找到 `[mysqld]` 部分
3. 添加：
   ```ini
   connect_timeout=60
   wait_timeout=28800
   interactive_timeout=28800
   ```
4. **保存** → **重启 MySQL**

### ❓ 问题 4: 导入 SQL 文件失败

**可能原因**:
- 文件太大
- 超时限制
- 权限不足

**解决方案**:

1. **增加 phpMyAdmin 上传限制**（宝塔）:
   - **软件商店** → **PHP** → **设置**
   - **配置修改** → 修改以下参数：
     ```ini
     upload_max_filesize = 100M
     post_max_size = 100M
     max_execution_time = 300
     max_input_time = 300
     ```

2. **使用命令行导入**:
   ```bash
   mysql -u learnsphere -p learnsphere_ai < schema.sql
   ```

3. **分批导入**:
   - 将大的 SQL 文件拆分成多个小文件
   - 逐个导入

### ❓ 问题 5: 无法连接到 MySQL

**检查 MySQL 状态**:
```bash
# 宝塔终端
systemctl status mysql

# 或
service mysql status
```

**重启 MySQL**:
```bash
systemctl restart mysql
```

**检查端口**:
```bash
netstat -tulnp | grep 3306
```

---

## 🔐 安全建议

### 1. 使用强密码

✅ **推荐密码格式**:
- 至少 12 位字符
- 包含大小写字母
- 包含数字
- 包含特殊字符 (!@#$%^&*)

❌ **避免使用**:
- 默认密码（如 123456）
- 简单密码（如 password）
- 与用户名相同的密码

### 2. 限制访问权限

```sql
-- 仅允许本地访问（推荐）
CREATE USER 'learnsphere'@'localhost' IDENTIFIED BY 'strong_password';

-- 允许特定 IP 访问
CREATE USER 'learnsphere'@'192.168.1.100' IDENTIFIED BY 'strong_password';

-- 避免使用 % 通配符（不安全）
-- CREATE USER 'learnsphere'@'%' IDENTIFIED BY 'password';  ❌
```

### 3. 定期备份

- ✅ 设置自动备份（每天）
- ✅ 保留多个备份版本（至少 7 天）
- ✅ 定期测试备份恢复
- ✅ 将备份文件存储到其他服务器

### 4. 监控日志

**宝塔面板查看日志**:
1. **数据库** → **MySQL** → **日志**
2. 查看错误日志和慢查询日志

**命令行查看**:
```bash
# 错误日志
tail -f /www/server/data/mysql-error.log

# 慢查询日志
tail -f /www/server/data/mysql-slow.log
```

### 5. 禁用 root 远程登录

```sql
-- 删除 root 远程访问权限
DELETE FROM mysql.user WHERE user='root' AND host!='localhost';
FLUSH PRIVILEGES;
```

---

## ✅ 初始化检查清单

完成数据库初始化后，请确认：

- [ ] 数据库 `learnsphere_ai` 已创建
- [ ] 字符集为 `utf8mb4`
- [ ] 用户 `learnsphere` 已创建并授权
- [ ] 所有表已成功导入
- [ ] 表结构正确（可查看任意表）
- [ ] 可以使用用户名密码登录数据库
- [ ] 后端配置文件已更新
- [ ] 自动备份任务已设置（生产环境）
- [ ] 密码已记录到安全位置

---

## 📞 需要帮助？

如果遇到问题：

1. **查看详细日志**
   - 宝塔面板：**数据库** → **MySQL** → **日志**
   - 命令行：`tail -f /www/server/data/mysql-error.log`

2. **参考相关文档**
   - [宝塔面板部署指南](./BAOTA_DEPLOYMENT.md)
   - [快速部署参考](../QUICK_DEPLOY.md)

3. **常见问题排查**
   - 检查 MySQL 服务是否运行
   - 检查用户名密码是否正确
   - 检查网络连接是否正常

---

**🎉 数据库初始化完成！** 

下一步：[部署后端应用](./BAOTA_DEPLOYMENT.md#第四步启动应用)
