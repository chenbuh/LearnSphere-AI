# VIP 会员制实现说明

## 功能概述

已实现完整的会员制+每日配额控制方案，包含以下核心功能：

1. **VIP 权限控制** - 非会员无法调用 AI 功能
2. **每日配额管理** - 即使是会员也有每日调用上限，防止滥用
3. **分级会员体系** - 支持月度/季度/年度不同等级会员
4. **配额实时统计** - 用户可查看今日配额使用情况

## 数据库修改

### 1. 执行 SQL 脚本

首先需要执行以下 SQL 脚本，为用户表添加 VIP 相关字段：

```bash
# 在 MySQL 中执行
mysql -u root -p learnsphere_ai < backend/src/main/resources/sql/add_vip_fields.sql
```

或者手动执行以下 SQL：

```sql
USE learnsphere_ai;

ALTER TABLE `user` 
ADD COLUMN `vip_expire_time` DATETIME NULL COMMENT 'VIP 过期时间' AFTER `current_level`,
ADD COLUMN `vip_level` TINYINT DEFAULT 0 COMMENT 'VIP 等级：0-普通，1-月度，2-季度，3-年度' AFTER `vip_expire_time`,
ADD COLUMN `daily_ai_quota` INT DEFAULT 200 COMMENT '每日 AI 调用配额' AFTER `vip_level`;

-- 设置普通用户配额为 0
UPDATE `user` SET `daily_ai_quota` = 0 WHERE `vip_expire_time` IS NULL OR `vip_expire_time` < NOW();
```

## Redis 配置

### 2. 安装并启动 Redis

```bash
# Windows 用户 - 下载并启动 Redis
# 下载地址：https://github.com/microsoftarchive/redis/releases
redis-server.exe

# 或使用 Docker
docker run -d -p 6379:6379 --name redis redis:latest
```

项目已自动配置 Redis 连接（`localhost:6379`），如需修改请编辑 `application.yml`。

## API 使用说明

### 管理员接口（需要 admin 角色）

#### 1. 授予用户 VIP

```http
POST /api/admin/vip/grant
Content-Type: application/json

{
  "userId": 1,
  "vipLevel": 1,      // 1-月度，2-季度，3-年度
  "duration": 1,      // 时长（月/季/年的数量）
  "dailyQuota": 200   // 每日配额（可选，默认 200）
}
```

#### 2. 取消用户 VIP

```http
POST /api/admin/vip/revoke/1
```

#### 3. 查询用户 VIP 状态

```http
GET /api/admin/vip/status/1
```

### 用户接口

#### 1. 查看个人信息（包含 VIP 状态）

```http
GET /api/user/info
```

返回示例：
```json
{
  "code": 200,
  "data": {
    "id": 1,
    "username": "test",
    "isVip": true,
    "vipLevel": 1,
    "vipExpireTime": "2026-02-15T21:55:00",
    "dailyAiQuota": 200
  }
}
```

#### 2. 查看今日配额使用情况

```http
GET /api/user/quota
```

返回示例：
```json
{
  "code": 200,
  "data": {
    "dailyQuota": 200,
    "usedToday": 15,
    "remainingToday": 185
  }
}
```

## 工作原理

### VIP 校验流程

1. 用户调用 AI 接口（如 `/api/ai/generate/reading`）
2. `@RequireVip` 注解触发 `VipCheckAspect` 切面
3. 切面执行以下检查：
   - ✅ 用户是否登录
   - ✅ 是否是有效 VIP（检查 `vip_expire_time > NOW()`）
   - ✅ VIP 等级是否满足要求
   - ✅ 今日配额是否已用完（从 Redis 获取）
4. 通过检查后执行业务逻辑，并在 Redis 中 +1 计数
5. 如任一检查失败，返回 403/429 错误

### 配额计数机制

- **存储位置**：Redis
- **Key 格式**：`quota:user:{userId}:{日期}`
  - 例如：`quota:user:1:2026-01-15`
- **过期时间**：1 天（自动清零）
- **计数逻辑**：每次调用 AI 接口，配额消耗值由 `@RequireVip(quotaCost = N)` 指定

### 配额消耗表

| 功能 | 配额消耗 | 说明 |
|------|---------|------|
| AI 阅读生成 | 1 | 生成一篇阅读文章 |
| AI 写作题目 | 1 | 生成写作题目 |
| AI 写作批改 | 2 | 批改作文（成本较高） |
| AI 听力生成 | 1 | 生成听力材料 |
| AI 语法生成 | 1 | 生成语法练习 |
| AI 口语生成 | 1 | 生成口语话题 |
| AI 口语评测 | 2 | 评测口语回答 |

## 测试步骤

### 1. 测试非会员拦截

1. 注册一个新用户（默认 `daily_ai_quota = 0`）
2. 调用任意 AI 接口，应返回：
   ```json
   {
     "code": 403,
     "msg": "此功能仅限 VIP 会员使用，请升级会员以解锁【AI 阅读理解生成】功能"
   }
   ```

### 2. 测试授予 VIP

1. 使用管理员账号调用 `/api/admin/vip/grant`
2. 再次调用 AI 接口，应正常返回
3. 调用 `/api/user/quota` 查看配额消耗

### 3. 测试配额上限

1. 将某个 VIP 用户的 `daily_ai_quota` 改为 5
2. 连续调用 6 次 AI 接口
3. 第 6 次应返回：
   ```json
   {
     "code": 429,
     "msg": "您今日的 AI 调用次数已达上限 (5/5)，请明天再试或联系客服提升配额"
   }
   ```

## 安全特性

✅ **双层防护**：VIP 校验 + API 限流（Rate Limit）  
✅ **防刷配额**：即使是会员也有每日上限（默认 200 次）  
✅ **分布式支持**：使用 Redis，支持多服务器部署  
✅ **自动重置**：每日凌晨配额自动清零  
✅ **细粒度控制**：不同功能可设置不同配额消耗  

## 常见问题

**Q: 如何临时提升某个用户的配额？**  
A: 直接修改数据库该用户的 `daily_ai_quota` 字段，或调用管理接口重新授予 VIP。

**Q: 配额何时重置？**  
A: Redis 的 Key 带有日期，每天自动生成新 Key，旧 Key 过期自动删除。

**Q: 如果 Redis 宕机会怎样？**  
A: `VipCheckAspect` 会抛出异常，AI 接口暂时不可用。建议配置 Redis 持久化或主从。

**Q: 如何设置免费试用配额？**  
A: 可以给新注册用户设置 `daily_ai_quota = 3`（不设置 VIP），让用户体验后再付费。

## 下一步优化建议

1. **支付集成** - 接入支付宝/微信支付，用户自助购买 VIP
2. **积分体系** - 打卡/分享等行为奖励积分，可兑换配额
3. **监控告警** - 当某用户配额消耗异常时发送告警
4. **VIP 权益扩展** - 不同等级 VIP 享有不同配额和专属功能

---

**实施完成时间**: 2026-01-15  
**版本**: v1.0
