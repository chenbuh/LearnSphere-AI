# 单词、例句与听力功能实现文档

本文档详细说明了 LearnSphere AI 中单词学习、例句生成以及听力训练功能的具体实现方案，包括核心逻辑、具体使用的 API 接口、技术架构及前后端交互细节。

---

## 1. 词汇与单词系统 (Vocabulary System)

词汇模块不仅是单词的展示，还集成了掌握度追踪和智能复习算法。

### 1.1 核心数据架构
- **后端模型**: `com.learnsphere.entity.Vocabulary` (基础信息) 与 `VocabularyMastery` (掌握进度)。
- **持久化层**: 
    - `vocabulary` 表：存储单词、音标、释义、例句、难度、频率、考试类型（cet4/cet6/ielts 等）。
    - `vocabulary_mastery` 表：存储用户 ID、单词 ID、掌握等级、复习次数、上次/下次复习时间。

### 1.2 后端 API 接口 (`vocabulary.js` & `mastery.js`)
- **列表查询**: `GET /vocabulary/list` - 支持按 `examType`、`difficulty` 和关键词搜索。
- **每日计划**: `GET /vocabulary/daily` - 根据用户计划获取今日需学习内容。
- **掌握度记录**: `POST /vocabulary/mastery/record` - 核心接口，接收 `vocabularyId` 和 `isCorrect`。
- **复习列表**: `GET /vocabulary/mastery/review-list` - 基于艾宾浩斯曲线计算出的待复习单词。
- **笔记辅助**: `POST /vocabulary/mastery/notes` - 用户可以为每个单词添加个性化笔记。

### 1.3 前端逻辑实现
- **Spaced Repetition (SRS)**: 前端通过 `useVocabularyStore` 管理状态，当用户点击“认识/不认识”时，触发 `recordReview` 异步更新后端的 `next_review_time`。
- **离线支持**: 部分数据通过 `indexedDB.js` 进行缓存，确保弱网环境下能继续浏览基本内容。

---

## 2. 增强型例句系统 (Enhanced Example Sentences)

为了解决数据库中例句可能缺失或质量不一的问题，系统实现了一套自动补偿机制。

### 2.1 多级获取逻辑 (`dictionaryApi.js`)
当用户查看单词详情时，系统按以下顺序请求例句：
1.  **DB Pre-load**: 使用后端返回的 `item.example`。
2.  **External API (Free Dictionary)**:
    - **URL**: `https://api.dictionaryapi.dev/api/v2/entries/en/${word}`
    - **逻辑**: 若 DB 无例句，前端调用此 API 提取 `meanings[].definitions[].example`。
3.  **Local Template Generation**:
    - **实现**: `generateExampleByCategory(word, meaning, category)`
    - **原理**: 根据词性（n/v/adj/adv）从本地模板池中随机抽取模板。例如动词模板：`She decided to ${w} the problem.`。系统会自动清洗释义中的中文干扰项，填充到模板中。

### 2.2 AI 深度交互
- **AI 联想助记**: 调用 `/ai/vocab/detail` 接口。
- **Prompt 设计**: 要求大模型基于词根词缀、词源以及常见的考试真题语境生成 200 字以内的深度解析。

---

## 3. 听力训练训练 (AI Listening Training)

听力模块是基于大模型生成能力与多厂商 TTS 合成能力的深度结合。

### 3.1 动态内容生成 (`ai.js`)
- **接口**: `POST /ai/generate/listening`
- **参数**: `type` (考试类型), `difficulty` (难度), `count` (篇章数)。
- **实现方案**: 
    - 后端调用 **Alibaba Bailian (阿里云百炼)** API 接入通义千问大模型。
    - **Output Format**: 强制要求输出 JSON，包含 `title`, `script` (长文本脚本), `questions` (题目数组)。
    - **JSON 结构示例**:
      ```json
      {
        "passages": [{
          "title": "Campus Life Discussion",
          "script": "User dialogue or lecture text...",
          "questions": [{"question": "...", "options": ["A", "B"...], "correct": 0}]
        }]
      }
      ```

### 3.2 语音播放与 fallback 机制 (`tts.js` & `VocabularyView.vue`)
为了应对长文本播放和 API 稳定性，系统实现了一套复杂的逻辑：

#### A. 听力长文本播放优先级：
1.  **欧路词典 Web API**: `https://api.frdic.com/api/v2/speech/speakweb?langid=en&txt=${text}` (语流极佳)。
2.  **Google TTS**: `https://translate.google.com/translate_tts?ie=UTF-8&q=${text}&tl=en&client=tw-ob`。
3.  **百度翻译 TTS**: `https://fanyi.baidu.com/gettts?lan=en&text=${text}&spd=3`。
4.  **Native TTS**: `window.speechSynthesis`。

#### B. 单词发音优先级：
1.  **Edge TTS (第三方解析)**: `https://api.oioweb.cn/api/txt/QQBubble`。
2.  **有道语音**: `https://dict.youdao.com/dictvoice?audio=${word}&type=2`。

### 3.3 交互组件设计 (`AudioPlayer.vue`)
- **可视化**: 使用 Canvas 绘制实时音频波形（基于模拟数据流）。
- **进度管理**: 
    - `playbackRate` 控制语速（0.5x - 2.0x）。
    - `audio.currentTime` 记录播放位置，支持“前进/后退 10秒”和“跳转至指定书签”。
- **学习记录**: 每次播放会触发 `listenCount` 增加，记录在前端缓存及后端 `LearningRecord` 中。

---

## 4. 技术栈摘要

| 层次 | 技术/服务 | 用途 |
| :--- | :--- | :--- |
| **API 请求** | Axios + `request.js` (带加密解密中间件) | 前后端通信 |
| **AI 模型** | 通义千问 (阿里云百炼) | 内容生成、助记、解析 |
| **外部字典** | Free Dictionary API / DictionaryAPI.dev | 补充词语定义与例句 |
| **TTS 合成** | Edge/Google/EuDic/Baidu/Youdao | 多重音频备份方案 |
| **本地存储** | Pinia (listeningStore) + IndexedDB | 进度持久化与离线缓存 |
| **动画/UI** | Lucide Vue Next + Naive UI | 图标与交互组件 |

---

## 5. 开发建议与注意事项

1.  **跨域处理**: 所有第三方 TTS API 均通过前端 `new Audio(url)` 调用，不涉及 CORS 限制，但需注意某些 API 的 Referer 检查（已在 `request.js` 处理）。
2.  **性能优化**: 听力脚本通常较长，生成需要 5-15 秒，前端实现了 `NSpin` 加载动画及分步恢复逻辑，防止用户在等待期间离开。
3.  **安全性**: 所有下发的 JSON 数据（如题目答案）均采用 `AES` 加密传输，前端通过 `decryptPayload` 解密，防止通过 Network 面板直接偷看答案。
4.  **协议说明**: 项目当前统一使用 **HTTP** 协议。虽然部分第三方 TTS/词典 API 仍使用 HTTPS 请求（如 Google/Youdao 等），但项目内部通信及前端服务已切换为 HTTP 以简化开发与本地部署。
