# 口语练习功能完善方案

## 📋 功能概述

口语练习系统现已包含以下核心功能：

### ✅ 已实现
1. **话题生成** - AI 生成雅思/托福等口语题目
2. **录音功能** - MediaRecorder API 录制音频
3. **实时语音识别** - Web Speech API 转文字
4. **AI 评分** - 综合评估发音、流畅度、内容完整性
5. **详细反馈** - 提供改进建议

### 🎯 新增改进
1. **音频录制工具** (`audioRecorder.js`) - 专业级录音管理
2. **发音评分系统** - 本地发音准确度评估
3. **音频可视化** - 实时波形/音量显示（可选）
4. **TTS 播放题目** - 使用现有的有道/必应 TTS 朗读题目

---

## 🚀 快速集成

### 1. 在 SpeakingView.vue 中使用新工具

```vue
<script setup>
import { ref, onUnmounted } from 'vue'
import { AudioRecorder, PronunciationScorer } from '@/utils/audioRecorder'
import { aiApi } from '@/api/ai'

const recorder = new AudioRecorder()
const isRecording = ref(false)
const audioBlob = ref(null)
const transcription = ref('')

// 开始录音
const startRecording = async () => {
  try {
    await recorder.startRecording()
    isRecording.value = true
  } catch (error) {
    message.error(error.message)
  }
}

// 停止录音
const stopRecording = async () => {
  try {
    const result = await recorder.stopRecording()
    audioBlob.value = result.blob
    transcription.value = result.transcription
    isRecording.value = false
    
    console.log('录音完成:', result)
  } catch (error) {
    message.error('录音失败')
  }
}

// 提交评估
const submitForEvaluation = async () => {
  // 方案 1: 仅发送文本（使用语音识别结果）
  const res = await aiApi.evaluateSpeaking({
    topic: topicData.value.title,
    transcription: transcription.value
  })
  
  // 方案 2: 发送音频文件（需要后端支持）
  // const formData = new FormData()
  // formData.append('audio', audioBlob.value)
  // formData.append('topic', topicData.value.title)
  // const res = await fetch('/api/ai/evaluate-speaking-audio', {
  //   method: 'POST',
  //   body: formData
  // })
  
  evaluationResult.value = res.data
}

// 本地发音评分（辅助功能）
const getQuickScore = () => {
  const expected = topicData.value.keywords.join(' ') // 期望包含的关键词
  const actual = transcription.value
  
  const score = PronunciationScorer.evaluatePronunciation(expected, actual)
  console.log('本地评分:', score)
}

onUnmounted(() => {
  recorder.destroy()
})
</script>
```

### 2. 添加音频波形可视化（可选）

```vue
<template>
  <div class="visualizer-container">
    <canvas ref="visualizerCanvas" width="300" height="100"></canvas>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { AudioAnalyzer } from '@/utils/audioRecorder'

const visualizerCanvas = ref(null)
let analyzer = null
let animationId = null

const startVisualization = (stream) => {
  analyzer = new AudioAnalyzer()
  analyzer.connectSource(stream)
  
  const canvas = visualizerCanvas.value
  const ctx = canvas.getContext('2d')
  
  const draw = () => {
    const waveform = analyzer.getWaveformData()
    const volume = analyzer.getVolumeLevel()
    
    ctx.clearRect(0, 0, canvas.width, canvas.height)
    ctx.fillStyle = '#6366f1'
    
    // 绘制波形
    waveform.forEach((value, index) => {
      const x = (index / waveform.length) * canvas.width
      const y = (value / 255) * canvas.height
      ctx.fillRect(x, canvas.height - y, 2, y)
    })
    
    animationId = requestAnimationFrame(draw)
  }
  
  draw()
}

const stopVisualization = () => {
  if (animationId) {
    cancelAnimationFrame(animationId)
  }
}
</script>
```

---

## 🎤 TTS 播放题目（已有方案）

在 `SpeakingView.vue` 中添加播放题目功能：

```vue
<script setup>
// 播放题目（使用现有 TTS）
const playQuestion = (text) => {
  const isSentence = text.includes(' ') || text.length > 30
  
  if (isSentence) {
    // 使用有道 TTS 播放
    const url = `https://api.frdic.com/api/v2/speech/speakweb?langid=en&txt=${encodeURIComponent(text)}`
    const audio = new Audio(url)
    audio.play().catch(() => {
      // 降级：使用系统 TTS
      const utterance = new SpeechSynthesisUtterance(text)
      utterance.lang = 'en-US'
      window.speechSynthesis.speak(utterance)
    })
  }
}
</script>

<template>
  <!-- 在题目卡片上添加播放按钮 -->
  <div class="question-header">
    <h3>{{ topicData.title }}</h3>
    <n-button circle @click="playQuestion(topicData.question)">
      <template #icon><Volume2 /></template>
    </n-button>
  </div>
</template>
```

---

## 📊 评分详解

### 后端 AI 评分（推荐）

调用通义千问 API，评估：
- **流畅度** (Fluency): 停顿、语速、连贯性
- **词汇** (Vocabulary): 词汇丰富度、准确性
- **语法** (Grammar): 时态、句式复杂度
- **相关性** (Relevance): 是否切题

### 前端本地评分（辅助）

`PronunciationScorer` 提供快速反馈：
- **准确度**: 基于编辑距离对比原文
- **完整度**: 关键词覆盖率
- **流畅度**: 词汇多样性、长度合理性

**使用场景**：
- 即时反馈（不等后端）
- 离线练习模式
- 辅助诊断

---

## 🔧 后端改进建议

### 支持音频上传（可选）

如果希望分析真实音频（而非仅文本），可添加：

```java
// SpeakingController.java

@PostMapping("/evaluate-audio")
public Result<?> evaluateAudio(
    @RequestParam("audio") MultipartFile audioFile,
    @RequestParam("topic") String topic
) {
    // 1. 保存音频文件
    String audioPath = saveAudio(audioFile);
    
    // 2. 调用语音识别 API（如阿里云、百度）
    String transcription = speechRecognitionService.recognize(audioPath);
    
    // 3. AI 评估
    Map<String, Object> evaluation = aiService.evaluateSpeaking(topic, transcription);
    
    // 4. 可选：发音分析（需第三方API）
    // Map<String, Object> pronunciation = pronunciationService.analyze(audioPath);
    
    return Result.success(evaluation);
}
```

---

## 📝 界面优化建议

### 1. 添加录音提示

```vue
<div class="recording-tips" v-if="isRecording">
  <n-alert type="info" title="录音中" :closable="false">
    <ul>
      <li>✓ 保持正常语速，不要太快或太慢</li>
      <li>✓ 尽量使用完整句子</li>
      <li>✓ 注意发音清晰度</li>
    </ul>
  </n-alert>
</div>
```

### 2. 实时文本显示

```vue
<div class="live-transcript">
  <h4>实时识别文本</h4>
  <p class="transcript-text">{{ transcription || '开始说话...' }}</p>
  <div class="word-count">词数: {{ transcription.split(' ').length }}</div>
</div>
```

### 3. 音量指示器

```vue
<div class="volume-meter">
  <n-progress 
    type="line" 
    :percentage="volumeLevel" 
    :show-indicator="false"
    :color="volumeLevel > 70 ? '#22c55e' : '#f59e0b'"
  />
  <span>音量: {{ volumeLevel }}%</span>
</div>
```

---

## 🎯 完整功能流程

```
1. 用户选择题型（雅思/托福/商务...）
   ↓
2. AI 生成口语题目
   ↓
3. TTS 朗读题目（可选）
   ↓
4. 用户点击录音按钮
   ↓
5. 实时语音识别 + 波形可视化
   ↓
6. 用户停止录音
   ↓
7. 本地快速评分（即时反馈）
   ↓
8. 提交到后端 AI 评估
   ↓
9. 显示详细评分和建议
   ↓
10. 保存学习记录
```

---

## 📦 所需依赖

前端（已包含在项目中）：
- ✅ Web Audio API（浏览器原生）
- ✅ Web Speech API（浏览器原生）
- ✅ MediaRecorder API（浏览器原生）

后端（已实现）：
- ✅ 通义千问 API（AI 评估）
- ⚪ 语音识别 API（可选，如阿里云ASR）
- ⚪ 发音评估 API（可选，如科大讯飞）

---

## 🚨 常见问题

### Q1: 语音识别不准确怎么办？
**A**: Web Speech API 依赖浏览器，Chrome 表现最好。如需更高精度，建议：
1. 使用后端语音识别 API（阿里云/百度/腾讯云）
2. 让用户手动编辑识别结果

### Q2: 如何支持离线模式？
**A**: 可以：
1. 仅使用本地评分（PronunciationScorer）
2. 保存录音到 IndexedDB，联网后批量上传

### Q3: 如何提升评分准确性？
**A**: 
1. 后端使用更强的 AI 模型（如 GPT-4）
2. 收集用户数据，训练专用模型
3. 结合真实音频分析（音高、节奏等）

---

## ✅ 下一步

1. **测试录音功能** - 打开浏览器控制台，检查权限
2. **调整 UI** - 添加实时文本显示、音量指示
3. **优化评分** - 调整权重，提供更详细的反馈
4. **数据统计** - 记录用户练习次数、进步曲线

需要我帮你实现其中的哪个模块？
