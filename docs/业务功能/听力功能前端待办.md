# å¬åŠ›è®­ç»ƒå‰ç«¯å¤šç¯‡ç« æ”¯æŒ - å¾…å®æ–½

## âœ… åç«¯å·²å®Œæˆ
- Serviceæ¥å£æ·»åŠ countå‚æ•° âœ…
- Controlleræ¥å—countå‚æ•° âœ…  
- å®ç°å¤šç¯‡ç« ç”Ÿæˆé€»è¾‘ âœ…
- AI Promptä¼˜åŒ– âœ…

## ğŸ”„ å‰ç«¯å¾…ä¿®æ”¹ (æ˜å¤©å®æ–½)

### 1. æ•°æ®ç»“æ„ä¿®æ”¹

```javascript
// ListeningView.vue
const passages = ref([])  // æ”¹ä¸ºå­˜å‚¨å¤šä¸ªç¯‡ç« 
const currentPassageIndex = ref(0)  // å½“å‰ç¯‡ç« ç´¢å¼•
const currentQuestionInPassage = ref(0)  // å½“å‰é¢˜åœ¨ç¯‡ç« ä¸­çš„ç´¢å¼•
const answersPerPassage = ref({})  // æŒ‰ç¯‡ç« å­˜å‚¨ç­”æ¡ˆ

const currentPassage = computed(() => passages.value[currentPassageIndex.value])
const currentQuestion = computed(() => {
    const passage = currentPassage.value
    if (!passage || !passage.questions) return null
    return passage.questions[currentQuestionInPassage.value]
})

// å…¨å±€é¢˜å·ï¼ˆè·¨ç¯‡ç« ï¼‰
const globalQuestionIndex = computed(() => {
    let index = 0
    for (let i = 0; i < currentPassageIndex.value; i++) {
        index += passages.value[i]?.questions?.length || 0
    }
    return index + currentQuestionInPassage.value
})
```

### 2. ä¿®æ”¹æ•°æ®åŠ è½½

```javascript
const generateQuestions = async () => {
    isLoading.value = true
    try {
        const res = await aiApi.generateListening({
            type: settings.value.examType,
            difficulty: settings.value.difficulty,
            count: settings.value.count  // å·²æ·»åŠ 
        })
        
        if (res.code === 200 && res.data) {
           // æ”¯æŒå¤šç¯‡ç« æ ¼å¼
           if (res.data.passages) {
               passages.value = res.data.passages
               // åˆå§‹åŒ–æ¯ä¸ªç¯‡ç« çš„ç­”æ¡ˆå­˜å‚¨
               answersPerPassage.value = {}
               passages.value.forEach((p, idx) => {
                   answersPerPassage.value[idx] = {}
               })
           } else {
               // å…¼å®¹æ—§æ ¼å¼
               passages.value = [{
                   id: 1,
                   title: res.data.title,
                   script: res.data.script,
                   questions: res.data.questions
               }]
           }
           
           currentPassageIndex.value = 0
           currentQuestionInPassage.value = 0
           step.value = 'testing'
           message.success(`ç”ŸæˆæˆåŠŸï¼š${res.data.totalPassages}ç¯‡å¬åŠ›ï¼Œå…±${res.data.totalQuestions}é“é¢˜`)
        }
    } catch (e) {
        console.error(e)
        message.error('ç”Ÿæˆå¤±è´¥')
    } finally {
        isLoading.value = false
    }
}
```

### 3. ä¿®æ”¹æ’­æ”¾é€»è¾‘

```javascript
const playAudio = () => {
    const passage = currentPassage.value
    if (!passage || !passage.script) {
        message.warning('å½“å‰ç¯‡ç« æ— éŸ³é¢‘æ–‡æœ¬')
        return
    }
    
    // åœæ­¢ä¹‹å‰çš„æ’­æ”¾
    stopAudio()
    
    // æ’­æ”¾å½“å‰ç¯‡ç« 
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(passage.script)
        utterance.lang = 'en-US'
        utterance.rate = settings.value.difficulty === 'slow' ? 0.8 : 
                        settings.value.difficulty === 'fast' ? 1.2 : 1.0
        
        utterance.onstart = () => { isPlaying.value = true }
        utterance.onend = () => { isPlaying.value = false }
        
        window.speechSynthesis.speak(utterance)
        message.success(`æ’­æ”¾ ${passage.title}`)
    }
}
```

### 4. ä¿®æ”¹é¢˜ç›®å¯¼èˆª

```javascript
const nextQuestion = () => {
    const passage = currentPassage.value
    if (!passage) return
    
    // åœ¨å½“å‰ç¯‡ç« å†…ç§»åŠ¨
    if (currentQuestionInPassage.value < passage.questions.length - 1) {
        currentQuestionInPassage.value++
    } else {
        // ç§»åŠ¨åˆ°ä¸‹ä¸€ç¯‡ç« 
        if (currentPassageIndex.value < passages.value.length - 1) {
            currentPassageIndex.value++
            currentQuestionInPassage.value = 0
            message.info(`è¿›å…¥${passages.value[currentPassageIndex.value].title}`)
        } else {
            // å…¨éƒ¨å®Œæˆ
            submitExam()
        }
    }
}

const prevQuestion = () => {
    if (currentQuestionInPassage.value > 0) {
        currentQuestionInPassage.value--
    } else if (currentPassageIndex.value > 0) {
        currentPassageIndex.value--
        const prevPassage = passages.value[currentPassageIndex.value]
        currentQuestionInPassage.value = prevPassage.questions.length - 1
    }
}

const goToQuestion = (passageIdx, questionIdx) => {
    if (passageIdx >= 0 && passageIdx < passages.value.length) {
        const passage = passages.value[passageIdx]
        if (questionIdx >= 0 && questionIdx < passage.questions.length) {
            currentPassageIndex.value = passageIdx
            currentQuestionInPassage.value = questionIdx
        }
    }
}
```

### 5. ä¿®æ”¹UIæ¨¡æ¿

```vue
<template>
  <!-- ç¯‡ç« ä¿¡æ¯æ  -->
  <div class="passage-header">
    <h3>{{ currentPassage?.title }}</h3>
    <span class="passage-progress">Passage {{ currentPassageIndex + 1 }} / {{ passages.length }}</span>
    <button @click="playAudio" class="play-btn">
      ğŸ”Š æ’­æ”¾å½“å‰ç¯‡ç« 
    </button>
  </div>

  <!-- é¢˜å·å¯¼èˆªï¼ˆæŒ‰ç¯‡ç« åˆ†ç»„ï¼‰ -->
  <div class="question-navigator">
    <div v-for="(passage, pIdx) in passages" :key="passage.id" class="passage-group">
      <div class="passage-label">Passage {{ pIdx + 1 }}</div>
      <div class="question-numbers">
        <div
          v-for="(q, qIdx) in passage.questions"
          :key="q.id"
          class="question-number"
          :class="{
            active: pIdx === currentPassageIndex && qIdx === currentQuestionInPassage,
            answered: answersPerPassage[pIdx]?.[qIdx] !== undefined
          }"
          @click="goToQuestion(pIdx, qIdx)"
        >
          {{ getGlobalQuestionNumber(pIdx, qIdx) }}
        </div>
      </div>
    </div>
  </div>

  <!-- é¢˜ç›®æ˜¾ç¤º -->
  <div class="question-content">
    <p class="q-number">Question {{ globalQuestionIndex + 1 }}</p>
    <h3 class="q-text">{{ currentQuestion?.question }}</h3>
    <!-- é€‰é¡¹ -->
  </div>
</template>
```

### 6. è¾…åŠ©å‡½æ•°

```javascript
const getGlobalQuestionNumber = (passageIdx, questionIdx) => {
    let num = 1
    for (let i = 0; i < passageIdx; i++) {
        num += passages.value[i]?.questions?.length || 0
    }
    return num + questionIdx
}

const selectAnswer = (optionIdx) => {
    if (!answersPerPassage.value[currentPassageIndex.value]) {
        answersPerPassage.value[currentPassageIndex.value] = {}
    }
    answersPerPassage.value[currentPassageIndex.value][currentQuestionInPassage.value] = optionIdx
}
```

## ğŸ“ CSSæ ·å¼æ·»åŠ 

```css
.passage-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: rgba(99, 102, 241, 0.1);
    border-radius: 12px;
    margin-bottom: 20px;
}

.passage-group {
    margin-bottom: 16px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
}

.passage-label {
    font-size: 0.85rem;
    color: #a1a1aa;
    margin-bottom: 8px;
    font-weight: 600;
}
```

## â° å®æ–½è®¡åˆ’

æ˜å¤©æŒ‰ä»¥ä¸‹é¡ºåºä¿®æ”¹ï¼š
1. ä¿®æ”¹æ•°æ®ç»“æ„ï¼ˆ10åˆ†é’Ÿï¼‰
2. ä¿®æ”¹æ•°æ®åŠ è½½ï¼ˆ10åˆ†é’Ÿï¼‰
3. ä¿®æ”¹å¯¼èˆªé€»è¾‘ï¼ˆ15åˆ†é’Ÿï¼‰
4. ä¿®æ”¹UIæ¨¡æ¿ï¼ˆ20åˆ†é’Ÿï¼‰
5. æ·»åŠ æ ·å¼ï¼ˆ10åˆ†é’Ÿï¼‰
6. æµ‹è¯•è°ƒè¯•ï¼ˆ15åˆ†é’Ÿï¼‰

æ€»è®¡çº¦80åˆ†é’Ÿå®Œæˆå‰ç«¯æ”¹é€ ã€‚
