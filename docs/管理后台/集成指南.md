# 交互体验增强组件 - 快速集成指南

## 已创建的组件

1. **DetailDrawer.vue** - 侧边抽屉式详情查看组件
2. **CommandPalette.vue** - 全局命令面板组件
3. **DetailDrawer.md** - 完整使用文档

---

## 第一步: 在 App.vue 中集成 CommandPalette

在现有的 App.vue 中,你已经有了一个基础的命令面板实现。为了使用新的增强版本,可以:

1. **保留现有实现** (推荐) - 当前的实现已经很好用
2. **或者替换为新组件** - 如果你需要更高级的功能

### 使用新 CommandPalette 组件 (可选)

```vue
<!-- App.vue -->
<script setup>
import CommandPalette from '@/components/CommandPalette.vue'

const showCommandPalette = ref(false)

// 自定义搜索用户ID的API
const searchUsers = async (query) => {
  try {
    const res = await adminApi.searchUsers(query)
    return res.data.map(user => ({
      id: `user-${user.id}`,
      type: 'user',
      title: user.username,
      description: user.email,
      icon: Users,
      onClick: () => {
        router.push(`/users?id=${user.id}`)
      }
    }))
  } catch (error) {
    return []
  }
}
</script>

<template>
  <!-- 现有内容... -->

  <!-- 替换现有的 command palette -->
  <command-palette
    v-model:show="showCommandPalette"
    :api="searchUsers"
  />
</template>
```

---

## 第二步: 在 Users.vue 中使用 DetailDrawer

找到 `Users.vue` 文件中的用户详情模态框部分,替换为 DetailDrawer:

### 1. 导入组件

```vue
<!-- Users.vue -->
<script setup>
import DetailDrawer from '@/components/DetailDrawer.vue'

// 添加新的状态
const showUserDrawer = ref(false)
const selectedUser = ref(null)
</script>
```

### 2. 创建计算属性生成 drawer 数据

```vue
<script setup>
// 快速信息卡片
const quickInfo = computed(() => {
  if (!selectedUser.value) return null

  return {
    userId: {
      label: '用户ID',
      value: selectedUser.value.id,
      valueClass: 'value-primary'
    },
    username: {
      label: '用户名',
      value: selectedUser.value.username,
      valueClass: 'value-success'
    },
    status: {
      label: '状态',
      value: selectedUser.value.status === 1 ? '正常' : '禁用',
      valueClass: selectedUser.value.status === 1 ? 'value-success' : 'value-error'
    },
    vipLevel: {
      label: 'VIP等级',
      value: selectedUser.value.vipLevel || '普通用户',
      valueClass: selectedUser.value.vipLevel ? 'value-warning' : ''
    },
    quota: {
      label: 'AI配额',
      value: `${selectedUser.value.dailyAiQuota || 0}/${selectedUser.value.dailyTutorQuota || 0}`
    },
    registerTime: {
      label: '注册时间',
      value: formatDateTime(selectedUser.value.createTime)
    }
  }
})

// 详细信息分组
const detailSections = computed(() => {
  if (!selectedUser.value) return []

  const user = selectedUser.value

  return [
    {
      title: '基本信息',
      items: [
        { label: '用户ID', value: user.id },
        { label: '用户名', value: user.username },
        { label: '昵称', value: user.nickname || '-' },
        { label: '邮箱', value: user.email || '-' },
        { label: '手机号', value: user.phone || '-' },
        { label: '状态', value: user.status === 1 ? '正常' : '禁用', tag: true, tagType: user.status === 1 ? 'success' : 'error' }
      ]
    },
    {
      title: 'VIP信息',
      items: [
        { label: 'VIP等级', value: user.vipLevel ? `Level ${user.vipLevel}` : '普通用户' },
        { label: '到期时间', value: user.vipExpireTime ? formatDateTime(user.vipExpireTime) : '非VIP用户' },
        { label: '每日AI配额', value: user.dailyAiQuota || 0 },
        { label: '每日助教配额', value: user.dailyTutorQuota || 0 }
      ]
    },
    {
      title: '统计信息',
      items: [
        { label: '学习天数', value: `${user.studyDays || 0} 天` },
        { label: '完成练习', value: user.completedExercises || 0 },
        { label: '获得成就', value: user.achievements || 0 }
      ]
    }
  ]
})

// 时间线 (最近操作)
const timeline = computed(() => {
  // 这里可以调用API获取用户的最近操作记录
  return [
    {
      title: '最近登录',
      content: `从 ${user.lastLoginIp || '未知IP'} 登录`,
      time: user.lastLoginTime ? formatDateTime(user.lastLoginTime) : '-',
      type: 'info'
    },
    {
      title: '注册时间',
      content: '用户注册加入 LearnSphere',
      time: user.createTime ? formatDateTime(user.createTime) : '-',
      type: 'success'
    }
  ]
})
</script>
```

### 3. 修改查看详情的处理函数

```vue
<script setup>
// 替换原有的 openDetailModal 函数
const openUserDrawer = async (user) => {
  selectedUser.value = user
  showUserDrawer.value = true

  // 如果需要加载更多数据
  // await fetchUserDetail(user.id)
}
</script>
```

### 4. 更新表格列的操作按钮

```vue
<script setup>
// 在 columns 定义中找到操作列
const columns = [
  // ... 其他列
  {
    title: '操作',
    key: 'actions',
    render(row) {
      return h('div', { class: 'flex gap-2' },
        h(NButton, {
          size: 'small',
          onClick: () => openUserDrawer(row)
        }, { default: () => '详情' })
        // ... 其他按钮
      )
    }
  }
]
</script>
```

### 5. 添加 DetailDrawer 到模板

```vue
<template>
  <div class="users-page">
    <!-- 现有内容 -->

    <!-- 移除或注释掉原有的 detail modal -->
    <!-- <n-modal v-model:show="showDetailModal">...</n-modal> -->

    <!-- 添加新的 DetailDrawer -->
    <detail-drawer
      v-model:show="showUserDrawer"
      :title="selectedUser?.username || '用户详情'"
      :subtitle="`ID: ${selectedUser?.id || ''}`"
      type="user"
      :data="selectedUser"
      :quick-info="quickInfo"
      :detail-sections="detailSections"
      :timeline="timeline"
      :show-edit="true"
      :show-delete="true"
      width="700"
      @edit="handleEditUser"
      @delete="handleDeleteUser"
    />
  </div>
</template>
```

---

## 第三步: 在 AIGovernance.vue 中使用 DetailDrawer

AI 治理页面可以用 Drawer 展示日志详情:

```vue
<!-- AIGovernance.vue -->
<script setup>
import DetailDrawer from '@/components/DetailDrawer.vue'

const showLogDrawer = ref(false)
const selectedLog = ref(null)

const viewLogDetail = (log) => {
  selectedLog.value = log
  showLogDrawer.value = true
}

const logQuickInfo = computed(() => {
  if (!selectedLog.value) return null

  return {
    action: {
      label: '操作类型',
      value: selectedLog.value.actionType,
      valueClass: 'value-primary'
    },
    model: {
      label: '使用的模型',
      value: selectedLog.value.modelName || '-'
    },
    status: {
      label: '状态',
      value: selectedLog.value.status,
      valueClass: selectedLog.value.status === 'SUCCESS' ? 'value-success' : 'value-error'
    },
    duration: {
      label: '耗时',
      value: `${selectedLog.value.durationMs || 0}ms`
    },
    tokens: {
      label: 'Token数',
      value: selectedLog.value.totalTokens || 0
    }
  }
})

const logSections = computed(() => {
  if (!selectedLog.value) return []

  return [
    {
      title: '请求信息',
      items: [
        { label: '操作ID', value: selectedLog.value.id },
        { label: '用户ID', value: selectedLog.value.userId || '系统' },
        { label: '操作类型', value: selectedLog.value.actionType },
        { label: '模型', value: selectedLog.value.modelName },
        { label: '状态', value: selectedLog.value.status, tag: true, tagType: selectedLog.value.status === 'SUCCESS' ? 'success' : 'error' }
      ]
    },
    {
      title: '性能指标',
      items: [
        { label: '耗时', value: `${selectedLog.value.durationMs}ms` },
        { label: '输入Tokens', value: selectedLog.value.inputTokens },
        { label: '输出Tokens', value: selectedLog.value.outputTokens },
        { label: '总Tokens', value: selectedLog.value.totalTokens }
      ]
    },
    {
      title: '提示词预览',
      items: [
        {
          label: '提示词',
          value: selectedLog.value.promptPreview?.substring(0, 200) + '...' || '-'
        }
      ]
    }
  ]
})
</script>

<template>
  <!-- 在日志表格的操作列添加按钮 -->
  <n-button
    size="small"
    @click="viewLogDetail(log)"
  >
    查看详情
  </n-button>

  <!-- 添加 DetailDrawer -->
  <detail-drawer
    v-model:show="showLogDrawer"
    title="AI 调用日志详情"
    type="log"
    :data="selectedLog"
    :quick-info="logQuickInfo"
    :detail-sections="logSections"
    width="800"
  />
</template>
```

---

## 第四步: 在 SensitiveAudit.vue 中使用

```vue
<!-- SensitiveAudit.vue -->
<script setup>
import DetailDrawer from '@/components/DetailDrawer.vue'

const showAuditDrawer = ref(false)
const selectedAudit = ref(null)

const viewAuditDetail = (audit) => {
  selectedAudit.value = audit
  showAuditDrawer.value = true
}
</script>

<template>
  <detail-drawer
    v-model:show="showAuditDrawer"
    title="敏感词审计详情"
    type="sensitive"
    :data="selectedAudit"
    width="600"
  />
</template>
```

---

## 效果对比

### 之前 (使用 Modal)
- ❌ 居中弹出,遮挡视线
- ❌ 大尺寸模态框在移动端体验差
- ❌ 与页面内容割裂

### 现在 (使用 Drawer)
- ✅ 右侧滑出,保持上下文
- ✅ 响应式设计,移动端全屏
- ✅ 平滑动画,视觉连贯
- ✅ ESC 键快速关闭

---

## 命令面板快捷键参考

| 快捷键 | 功能 |
|--------|------|
| `Ctrl+K` (Mac: `Cmd+K`) | 打开/关闭命令面板 |
| `↑` `↓` | 上下导航 |
| `Enter` | 选择项目 |
| `Esc` | 关闭面板 |

---

## 注意事项

1. **不要删除现有的模态框实现** - 先测试 Drawer 再决定是否替换
2. **响应式宽度** - Drawer 在移动端会自动变为全屏
3. **数据量控制** - detailSections 不宜过多,建议 3-5 个分组
4. **性能优化** - 大数据量考虑分页或虚拟滚动
5. **无障碍访问** - 两个组件都支持键盘操作

---

## 下一步优化建议

1. **添加更多命令** - 在 CommandPalette 中添加常用操作的快捷方式
2. **自定义主题** - 根据品牌调整颜色和样式
3. **数据分析** - 统计最常用的命令,优化排序
4. **快捷键提示** - 在界面中显示快捷键提示,提升用户发现性

---

## 文件清单

已创建/修改的文件:

1. ✅ `admin-vue/src/components/DetailDrawer.vue` - 抽屉组件
2. ✅ `admin-vue/src/components/CommandPalette.vue` - 命令面板组件
3. ✅ `admin-vue/src/components/DetailDrawer.md` - 使用文档
4. ✅ `admin-vue/INTEGRATION_GUIDE.md` - 本集成指南
5. ⏸️ `admin-vue/src/App.vue` - (可选) 升级命令面板
6. ⏸️ `admin-vue/src/views/Users.vue` - (待) 集成 Drawer
7. ⏸️ `admin-vue/src/views/AIGovernance.vue` - (待) 集成 Drawer
8. ⏸️ `admin-vue/src/views/SensitiveAudit.vue` - (待) 集成 Drawer

---

**开始使用**: 从 `Users.vue` 开始,先实现一个页面的 Drawer,验证效果后再推广到其他页面。
