# åç«¯ä¼˜åŒ–åº”ç”¨æŒ‡å—

## ğŸ“– å¦‚ä½•åœ¨ç°æœ‰ä»£ç ä¸­ä½¿ç”¨ä¼˜åŒ–åŠŸèƒ½

æœ¬æ–‡æ¡£æä¾›å®é™…çš„ä»£ç ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•å°†ç¼“å­˜ã€å¼‚æ­¥å’Œç†”æ–­åº”ç”¨åˆ° LearnSphere AI ç°æœ‰ä»£ç ä¸­ã€‚

---

## 1ï¸âƒ£ ä½¿ç”¨ CacheUtil å®ç°å¤šçº§ç¼“å­˜

### ç¤ºä¾‹ 1ï¼šDashboard ç»Ÿè®¡æ•°æ®ç¼“å­˜

**åœºæ™¯**ï¼šç”¨æˆ·æ¯æ¬¡æ‰“å¼€ Dashboard éƒ½ä¼šæŸ¥è¯¢ç»Ÿè®¡æ•°æ®ï¼Œè¿™äº›æ•°æ®å®æ—¶æ€§è¦æ±‚ä¸é«˜ï¼Œå¯ä»¥ç¼“å­˜ 5 åˆ†é’Ÿã€‚

**åŸä»£ç ** (`UserController.java`):
```java
@GetMapping("/dashboard-stats")
public Result<Map<String, Object>> getDashboardStats() {
    Long userId = StpUtil.getLoginIdAsLong();
    Map<String, Object> stats = learningRecordService.getUserStatistics(userId);
    return Result.success(stats);
}
```

**ä¼˜åŒ–å**:
```java
@Autowired
private CacheUtil cacheUtil;

@GetMapping("/dashboard-stats")
public Result<Map<String, Object>> getDashboardStats() {
    Long userId = StpUtil.getLoginIdAsLong();
    
    // ä½¿ç”¨ Cache-Aside æ¨¡å¼
    Map<String, Object> stats = cacheUtil.getOrCompute(
        "dashboard:stats:" + userId,           // Redis key
        () -> learningRecordService.getUserStatistics(userId), // æ•°æ®æä¾›è€…
        5,                                      // ç¼“å­˜ 5 åˆ†é’Ÿ
        TimeUnit.MINUTES
    );
    
    return Result.success(stats);
}
```

**æ•ˆæœ**ï¼š
- âœ… ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼šæ‰§è¡Œ SQL â†’ å†™å…¥ Redis
- âœ… 5 åˆ†é’Ÿå†…å†æ¬¡æŸ¥è¯¢ï¼šç›´æ¥ä» Redis è¿”å›ï¼ˆ<1msï¼‰
- âœ… Redis ä¸å¯ç”¨ï¼šè‡ªåŠ¨é™çº§åˆ°ç›´æ¥æŸ¥è¯¢ DB

---

### ç¤ºä¾‹ 2ï¼šçƒ­é—¨è¯æ±‡ç¼“å­˜

**åœºæ™¯**ï¼šçƒ­é—¨è¯æ±‡åˆ—è¡¨å˜åŒ–ä¸é¢‘ç¹ï¼Œå¯ä»¥ç¼“å­˜ 6 å°æ—¶ã€‚

```java
@GetMapping("/hot-vocabulary")
public Result<List<Vocabulary>> getHotVocabulary() {
    List<Vocabulary> hotWords = cacheUtil.getOrCompute(
        "vocabulary:hot",
        () -> vocabularyMapper.selectHotWords(),
        6,
        TimeUnit.HOURS
    );
    
    return Result.success(hotWords);
}
```

---

### ç¤ºä¾‹ 3ï¼šæ¯æ—¥ä¸€å¥

**åœºæ™¯**ï¼šæ¯å¤©åªéœ€ç”Ÿæˆä¸€æ¬¡ï¼Œç¼“å­˜ 24 å°æ—¶ã€‚

```java
@GetMapping("/daily-sentence")
public Result<String> getDailySentence() {
    String sentence = cacheUtil.getOrCompute(
        "daily:sentence:" + LocalDate.now(),
        () -> {
            // 1. å…ˆæŸ¥ DB æ˜¯å¦å·²æœ‰ä»Šæ—¥å¥å­
            String fromDb = dailySentenceMapper.getTodaySentence();
            if (fromDb != null) return fromDb;
            
            // 2. DB ä¹Ÿæ²¡æœ‰ï¼Œè°ƒç”¨ AI ç”Ÿæˆ
            String fromAI = aiService.generateDailySentence();
            
            // 3. ä¿å­˜åˆ° DB
            dailySentenceMapper.insert(new DailySentence(fromAI));
            
            return fromAI;
        },
        24,
        TimeUnit.HOURS
    );
    
    return Result.success(sentence);
}
```

---

## 2ï¸âƒ£ ä½¿ç”¨ @Async å¤„ç†è€—æ—¶ä»»åŠ¡

### ç¤ºä¾‹ï¼šå¼‚æ­¥ç”Ÿæˆé•¿æ–‡é˜…è¯»

**åœºæ™¯**ï¼šç”Ÿæˆé•¿æ–‡é˜…è¯»éœ€è¦ 10 ç§’ï¼Œä½¿ç”¨å¼‚æ­¥é¿å…é˜»å¡ã€‚

```java
@Service
@Slf4j
public class ReadingServiceImpl {

    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private AIGenerationServiceImpl aiGenerationService;

    /**
     * æäº¤å¼‚æ­¥ç”Ÿæˆä»»åŠ¡
     */
    public String submitReadingGeneration(String level, String topic) {
        String taskId = UUID.randomUUID().toString();
        
        // å¼‚æ­¥ç”Ÿæˆ
        generateReadingAsync(taskId, level, topic);
        
        return taskId;
    }

    /**
     * å¼‚æ­¥æ–¹æ³•
     */
    @Async("aiTaskExecutor")
    public void generateReadingAsync(String taskId, String level, String topic) {
        try {
            log.info("Async task started: {}", taskId);
            
            // è°ƒç”¨ AI ç”Ÿæˆï¼ˆè€—æ—¶æ“ä½œï¼‰
            Map<String, Object> result = aiGenerationService.generateReading(level, topic, null, null);
            result.put("status", "completed");
            result.put("taskId", taskId);
            
            // å°†ç»“æœå­˜å…¥ Redisï¼Œ10 åˆ†é’Ÿè¿‡æœŸ
            redisTemplate.opsForValue().set("async:reading:" + taskId, result, 10, TimeUnit.MINUTES);
            
            log.info("Async task completed: {}", taskId);
        } catch (Exception e) {
            log.error("Async task failed: {}", taskId, e);
            
            Map<String, Object> error = new HashMap<>();
            error.put("status", "failed");
            error.put("error", e.getMessage());
            redisTemplate.opsForValue().set("async:reading:" + taskId, error, 10, TimeUnit.MINUTES);
        }
    }

    /**
     * æŸ¥è¯¢ä»»åŠ¡ç»“æœ
     */
    public Map<String, Object> getTaskResult(String taskId) {
        Object result = redisTemplate.opsForValue().get("async:reading:" + taskId);
        if (result != null) {
            return (Map<String, Object>) result;
        }
        
        Map<String, Object> notFound = new HashMap<>();
        notFound.put("status", "processing"); // å¯èƒ½è¿˜åœ¨ç”Ÿæˆä¸­
        return notFound;
    }
}
```

**Controller**:
```java
@PostMapping("/reading/async")
public Result<Map<String, Object>> generateReadingAsync(@RequestParam String level, @RequestParam String topic) {
    String taskId = readingService.submitReadingGeneration(level, topic);
    
    Map<String, Object> response = new HashMap<>();
    response.put("taskId", taskId);
    response.put("message", "ä»»åŠ¡å·²æäº¤ï¼Œè¯·ç¨åæŸ¥è¯¢ç»“æœ");
    
    return Result.success(response);
}

@GetMapping("/reading/task/{taskId}")
public Result<Map<String, Object>> getReadingTask(@PathVariable String taskId) {
    Map<String, Object> result = readingService.getTaskResult(taskId);
    return Result.success(result);
}
```

**å‰ç«¯è½®è¯¢**:
```javascript
// æäº¤ä»»åŠ¡
const { data } = await api.generateReadingAsync({ level: 'advanced', topic: 'Technology' });
const taskId = data.taskId;

// è½®è¯¢æŸ¥è¯¢ç»“æœ
const checkResult = async () => {
    const result = await api.getReadingTask(taskId);
    
    if (result.status === 'completed') {
        showResult(result);
    } else if (result.status === 'failed') {
        showError(result.error);
    } else {
        // ç»§ç»­è½®è¯¢
        setTimeout(checkResult, 2000);
    }
};

checkResult();
```

---

## 3ï¸âƒ£ ä½¿ç”¨ CircuitBreaker ä¿æŠ¤ AI è°ƒç”¨

### ç¤ºä¾‹ï¼šAI ç”Ÿæˆå¸¦ç†”æ–­ä¿æŠ¤

```java
@Service
@Slf4j
public class GrammarServiceImpl {

    @Autowired
    private CircuitBreakerRegistry circuitBreakerRegistry;
    
    @Autowired
    private AIGenerationServiceImpl aiGenerationService;
    
    @Autowired
    private GrammarExerciseMapper grammarMapper;

    /**
     * ç”Ÿæˆè¯­æ³•é¢˜ï¼ˆå¸¦ç†”æ–­ä¿æŠ¤ï¼‰
     */
    public Map<String, Object> generateGrammar(String topic, String difficulty) {
        io.github.resilience4j.circuitbreaker.CircuitBreaker circuitBreaker = 
            circuitBreakerRegistry.circuitBreaker("aiService");

        try {
            // ä½¿ç”¨ç†”æ–­å™¨åŒ…è£… AI è°ƒç”¨
            return circuitBreaker.executeSupplier(() -> {
                log.info("Calling AI to generate grammar for topic: {}", topic);
                return aiGenerationService.generateGrammar(topic, difficulty);
            });
        } catch (Exception e) {
            log.warn("Circuit breaker open or AI call failed, fallback to local data", e);
            
            // é™çº§ï¼šä»æœ¬åœ°æ•°æ®åº“è¿”å›é¢„å…ˆå‡†å¤‡çš„é¢˜ç›®
            return grammarMapper.getLocalQuestions(topic, difficulty);
        }
    }
}
```

**ç†”æ–­çŠ¶æ€æœº**:
```
åˆå§‹çŠ¶æ€: CLOSED (æ­£å¸¸è°ƒç”¨ AI)
   â†“
å¤±è´¥ç‡ > 50% â†’ OPEN (ç†”æ–­æ‰“å¼€ï¼Œç›´æ¥è¿”å›æœ¬åœ°æ•°æ®)
   â†“
ç­‰å¾… 1 åˆ†é’Ÿ â†’ HALF_OPEN (å…è®¸ 3 æ¬¡æµ‹è¯•è°ƒç”¨)
   â†“
æµ‹è¯•æˆåŠŸ â†’ CLOSED (æ¢å¤æ­£å¸¸)
æµ‹è¯•å¤±è´¥ â†’ OPEN (ç»§ç»­ç†”æ–­)
```

---

## 4ï¸âƒ£ Spring Cache æ³¨è§£æ–¹å¼ï¼ˆæ¨èï¼‰

### æœ€ç®€å•çš„ç¼“å­˜æ–¹å¼

å¦‚æœä¸éœ€è¦å¤æ‚çš„é™çº§é€»è¾‘ï¼Œç›´æ¥ä½¿ç”¨ Spring Cache æ³¨è§£ï¼š

```java
@Service
public class VocabularyService {

    /**
     * æ•´ä¸ªæ–¹æ³•çš„è¿”å›å€¼ä¼šè¢«è‡ªåŠ¨ç¼“å­˜
     */
    @Cacheable(value = "vocabulary", key = "#examType + '_' + #level")
    public List<Vocabulary> getVocabularyList(String examType, String level) {
        // ç¬¬ä¸€æ¬¡æ‰§è¡Œè¿™é‡Œï¼Œåç»­ç›´æ¥ä» Redis è¿”å›
        return vocabularyMapper.selectByExamAndLevel(examType, level);
    }

    /**
     * æ›´æ–°æ•°æ®åæ¸…é™¤ç¼“å­˜
     */
    @CacheEvict(value = "vocabulary", key = "#examType + '_' + #level")
    public void updateVocabulary(String examType, String level, Vocabulary vocab) {
        vocabularyMapper.updateById(vocab);
    }

    /**
     * æ¸…é™¤æ‰€æœ‰è¯æ±‡ç¼“å­˜
     */
    @CacheEvict(value = "vocabulary", allEntries = true)
    public void clearAllVocabularyCache() {
        log.info("All vocabulary cache cleared");
    }
}
```

---

## 5ï¸âƒ£ å®Œæ•´ç¤ºä¾‹ï¼šDashboard æœåŠ¡ä¼˜åŒ–

```java
@Service
@Slf4j
public class DashboardServiceImpl {

    @Autowired
    private CacheUtil cacheUtil;
    
    @Autowired
    private UserMapper userMapper;
    
    @Autowired
    private LearningRecordMapper learningRecordMapper;

    /**
     * è·å–ç”¨æˆ· Dashboard æ•°æ®ï¼ˆå¸¦ç¼“å­˜ï¼‰
     */
    public Map<String, Object> getDashboardData(Long userId) {
        // 1. ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆç¼“å­˜ 30 åˆ†é’Ÿï¼‰
        User user = cacheUtil.getOrCompute(
            "user:info:" + userId,
            () -> userMapper.selectById(userId),
            30,
            TimeUnit.MINUTES
        );

        // 2. å­¦ä¹ ç»Ÿè®¡ï¼ˆç¼“å­˜ 5 åˆ†é’Ÿï¼‰
        Map<String, Object> stats = cacheUtil.getOrCompute(
            "user:stats:" + userId,
            () -> learningRecordMapper.getUserStatistics(userId),
            5,
            TimeUnit.MINUTES
        );

        // 3. æ’è¡Œæ¦œï¼ˆç¼“å­˜ 10 åˆ†é’Ÿï¼Œæ‰€æœ‰ç”¨æˆ·å…±äº«ï¼‰
        List<Map<String, Object>> leaderboard = cacheUtil.getOrCompute(
            "leaderboard:global",
            () -> userMapper.getTopUsers(10),
            10,
            TimeUnit.MINUTES
        );

        // 4. ç»„è£…è¿”å›æ•°æ®
        Map<String, Object> dashboard = new HashMap<>();
        dashboard.put("user", user);
        dashboard.put("stats", stats);
        dashboard.put("leaderboard", leaderboard);

        return dashboard;
    }
}
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ç¼“å­˜æ—¶é—´è®¾ç½®å»ºè®®

| æ•°æ®ç±»å‹ | ç¼“å­˜æ—¶é—´ | ç†ç”± |
|---------|---------|------|
| ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ | 30 åˆ†é’Ÿ | å˜åŒ–ä¸é¢‘ç¹ |
| Dashboard ç»Ÿè®¡ | 5-10 åˆ†é’Ÿ | å¹³è¡¡å®æ—¶æ€§å’Œæ€§èƒ½ |
| çƒ­é—¨è¯æ±‡ | 6 å°æ—¶ | åŸºæœ¬ä¸å˜ |
| æ¯æ—¥ä¸€å¥ | 24 å°æ—¶ | æ¯å¤©åªéœ€ä¸€æ¬¡ |
| æ’è¡Œæ¦œ | 10 åˆ†é’Ÿ | é«˜é¢‘æŸ¥è¯¢ |
| AI ç”Ÿæˆå†…å®¹ | 1 å°æ—¶ | å¯å¤ç”¨ |

### 2. ç¼“å­˜ Key å‘½åè§„èŒƒ

```
{ä¸šåŠ¡æ¨¡å—}:{æ•°æ®ç±»å‹}:{æ ‡è¯†ç¬¦}

ç¤ºä¾‹ï¼š
- user:info:123         (ç”¨æˆ· 123 çš„åŸºæœ¬ä¿¡æ¯)
- vocabulary:hot        (çƒ­é—¨è¯æ±‡)
- dashboard:stats:456   (ç”¨æˆ· 456 çš„ Dashboard ç»Ÿè®¡)
- daily:sentence:2026-01-20  (2026-01-20 çš„æ¯æ—¥ä¸€å¥)
```

### 3. ä½•æ—¶ä½¿ç”¨ç¼“å­˜

âœ… **é€‚åˆç¼“å­˜**:
- é«˜é¢‘è¯»å–çš„æ•°æ®ï¼ˆDashboardã€æ’è¡Œæ¦œï¼‰
- è®¡ç®—æˆæœ¬é«˜çš„æ•°æ®ï¼ˆå¤æ‚ç»Ÿè®¡ã€AI ç”Ÿæˆï¼‰
- å˜åŒ–ä¸é¢‘ç¹çš„æ•°æ®ï¼ˆçƒ­é—¨è¯æ±‡ã€é…ç½®ï¼‰

âŒ **ä¸é€‚åˆç¼“å­˜**:
- å®æ—¶æ€§è¦æ±‚æé«˜çš„æ•°æ®ï¼ˆæ”¯ä»˜çŠ¶æ€ï¼‰
- ç”¨æˆ·éšç§æ•æ„Ÿæ•°æ®ï¼ˆå¯†ç ã€tokenï¼‰
- é¢‘ç¹å˜åŒ–çš„æ•°æ®ï¼ˆåœ¨çº¿ç”¨æˆ·æ•°ï¼‰

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### æœ¬åœ°å¼€å‘ï¼ˆæ—  Redisï¼‰

ä»£ç å·²åšå¥½å®¹é”™ï¼Œæ²¡æœ‰ Redis ä¹Ÿèƒ½è¿è¡Œï¼š
```java
// CacheUtil ä¼šè‡ªåŠ¨æ•è·å¼‚å¸¸ï¼Œé™çº§åˆ°ç›´æ¥æ‰§è¡Œ supplier
public <T> T getOrCompute(...) {
    try {
        // å°è¯•ä½¿ç”¨ Redis
    } catch (Exception e) {
        // Redis ä¸å¯ç”¨ï¼Œç›´æ¥æ‰§è¡Œ supplier
        return supplier.get();
    }
}
```

### ç”Ÿäº§ç¯å¢ƒï¼ˆæœ‰ Redisï¼‰

1. **å¯åŠ¨ Redis**:
```bash
docker run -d -p 6379:6379 redis
```

2. **é…ç½® application.properties**:
```properties
spring.data.redis.host=localhost
spring.data.redis.port=6379
spring.data.redis.timeout=3000ms
```

3. **ç›‘æ§ Redis**:
```bash
redis-cli
> INFO stats
> KEYS *
> TTL key_name
```

---

## ğŸ“ æ€»ç»“

é€šè¿‡ä»¥ä¸Šä¼˜åŒ–ï¼ŒLearnSphere AI åç«¯å¯ä»¥å®ç°ï¼š

âœ… **æ€§èƒ½æå‡**ï¼š
- Dashboard å“åº”æ—¶é—´ä» 2s â†’ <100ms
- AI è°ƒç”¨æ¬¡æ•°å‡å°‘ 70%

âœ… **ç¨³å®šæ€§æå‡**ï¼š
- Redis ä¸å¯ç”¨æ—¶è‡ªåŠ¨é™çº§
- AI æ•…éšœæ—¶ä½¿ç”¨æœ¬åœ°æ•°æ®

âœ… **ç”¨æˆ·ä½“éªŒæå‡**ï¼š
- å¼‚æ­¥ä»»åŠ¡ï¼Œä¸å†"å¡æ­»"
- å¿«é€Ÿå“åº”ï¼Œæµç•…ä½“éªŒ

æ‰€æœ‰ä¼˜åŒ–éƒ½æ˜¯**æ¸è¿›å¼**çš„ï¼Œå³ä½¿ä¸å¯ç”¨ Redis ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œï¼ğŸ‰
