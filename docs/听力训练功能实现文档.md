# 听力训练功能实现文档

## 1. 功能概述

听力训练模块旨在通过 AI 生成定制化的听力材料（对话或短文），并配套相应的理解测试题。系统模拟真实的听力考试场景（如雅思/托福），支持音频播放控制、答题互动及结果分析。

## 2. 数据库设计

### 核心表：`listening_material`
存储 AI 生成的听力脚本和题目。

```sql
CREATE TABLE listening_material (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    title VARCHAR(255),            -- 听力标题
    script TEXT,                   -- 听力原文脚本 (对话/独白)
    type VARCHAR(20),              -- 类型 (conversation, monologue)
    difficulty VARCHAR(20),        -- 难度
    questions JSON,                -- 题目数据(List<Question>)
    audio_url VARCHAR(500),        -- 音频文件地址 (如有)
    deleted TINYINT DEFAULT 0,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

## 3. 后端实现

### 3.1 核心服务 (`AIGenerationServiceImpl.java`)

1.  **Prompt 构建**:
    *   根据用户选择的场景（生活、学术、商务）和难度，要求 AI 生成一段 300-500 词的对话或独白。
    *   要求 AI 基于内容出 3-5 道选择题。

2.  **生成逻辑**:
    *   调用通义千问生成 JSON 格式的脚本和题目。
    *   **TTS 集成 (未来规划)**: 目前仅存储脚本，前端可使用浏览器自带 TTS 或集成 Azure TTS 将文本转语音。

### 3.2 接口

*   `POST /api/ai/listening/generate`: 生成听力材料。
*   `GET /api/ai/listening/history`: 获取历史记录。

## 4. 前端实现 (`ListeningView.vue`)

### 4.1 交互流程
1.  **设置**: 选择听力类型（如 IELTS Section 1 对话, Lecture 讲座）。
2.  **播放与答题**:
    *   **音频播放器**: 自定义播放控件，可视化声波纹（mock），支持播放/暂停/进度拖拽。
    *   **盲听模式**: 默认隐藏脚本，仅显示题目。
    *   **脚本跟随**: 答题结束后可查看原文脚本，支持点击脚本句段跳转播放。
3.  **结果反馈**: 自动评分，显示正确答案。

### 4.2 关键技术
*   `window.speechSynthesis`: 利用浏览器原生 API 进行文本转语音播放。
*   **状态控制**: 管理播放状态（Playing/Paused）与答题状态（Answering/Reviewing）。

## 5. 业务流程

```mermaid
graph LR
    User[用户] -->|选择话题/难度| FE[前端];
    FE -->|请求生成| BE[后端 API];
    BE -->|Prompt| AI[通义千问];
    AI -->|JSON (脚本+题目)| BE;
    BE -->|保存| DB[(数据库)];
    BE -->|返回数据| FE;
    FE -->|TTS 合成音频| Player[播放器];
    User -->|听音答题| FE;
    User -->|提交| FE;
    FE -->|显示分数 & 脚本| User;
```
