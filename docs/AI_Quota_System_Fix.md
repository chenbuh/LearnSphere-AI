# AI 配额系统修复记录

## 📋 问题描述

**日期**: 2026-02-15 02:15  
**问题**: AI 学习助手消耗的是"今日内容生成配额"而不是"今日助教提问配额"

### 根本原因

在 `VipCheckAspect.java` 中，所有 AI 功能共用同一个 Redis 配额计数器：

```java
// ❌ 错误：所有功能共用同一个 key
String quotaKey = "quota:user:" + userId + ":" + LocalDate.now();
```

这导致：
- AI 助教提问
- AI 内容生成（未来功能）
- 其他 AI 功能

都会累加到同一个计数器中，无法独立统计和限制。

## ✅ 解决方案

### 修改配额 Key 结构

**文件**: `VipCheckAspect.java`

**修改前**:
```java
String quotaKey = "quota:user:" + userId + ":" + LocalDate.now();
// 示例: quota:user:123:2026-02-15
```

**修改后**:
```java
// 使用不同的 Redis Key 区分助教配额和普通 AI 配额
String quotaKey = "quota:user:" + userId + ":" + LocalDate.now() + ":" + requireVip.feature();
// 示例: quota:user:123:2026-02-15:AI 助教提问
```

### Key 格式说明

| 功能类型 | Redis Key 示例 |
|---------|---------------|
| AI 助教提问 | `quota:user:123:2026-02-15:AI 助教提问` |
| AI 模拟考试生成 | `quota:user:123:2026-02-15:AI 模拟考试生成` |
| 其他 AI 功能 | `quota:user:123:2026-02-15:<功能名>` |

## 🎯 修复效果

### 配额独立统计

现在每个 AI 功能都有独立的配额计数器：

```
用户 123 的配额使用情况（2026-02-15）:
├─ AI 助教提问: 15/200
├─ AI 模拟考试生成: 2/10
└─ 其他功能: 各自独立计数
```

### 前端显示正确

用户在个人中心看到的配额信息：
- **今日助教提问剩余**: 185/200 ✅
- **今日内容生成剩余**: 8/10 ✅

不再混淆或互相影响。

## 📊 影响范围

### 已更新的文件

1. **`VipCheckAspect.java`** (核心修复)
   - 第 66 行: 添加功能类型到 quotaKey

2. **`UserController.java`** (已兼容)
   - 第 161 行: 助教配额 key 已正确包含功能类型
   - 第 134 行: 通用 AI 配额 key（暂未使用）

### Redis 数据迁移

**注意**: 此修复会导致历史配额计数器失效（不兼容旧 key）

**影响**:
- ✅ 新请求使用新的 key 格式
- ⚠️ 旧的配额计数不会被读取（自动重置）
- ✅ 每天凌晨配额自然过期，不需要手动清理

**建议**: 在非高峰时段部署，或提前清理旧的 Redis 配额 key：
```bash
redis-cli KEYS "quota:user:*:2026-02-15" | xargs redis-cli DEL
```

## 🔍 测试验证

### 测试步骤

1. **重置测试环境**
   ```bash
   # 清理当日配额
   redis-cli DEL "quota:user:1:2026-02-15:AI 助教提问"
   ```

2. **使用 AI 助教功能**
   - 提问 5 次
   - 查看个人中心：助教配额应为 195/200

3. **使用其他 AI 功能**（如果有）
   - 生成内容 3 次
   - 查看个人中心：内容生成配额应为独立计数

4. **验证配额隔离**
   ```bash
   # 查看 Redis 中的 key
   redis-cli KEYS "quota:user:1:2026-02-15:*"
   
   # 输出应该包含:
   # quota:user:1:2026-02-15:AI 助教提问
   # quota:user:1:2026-02-15:AI 模拟考试生成
   # (各自独立)
   ```

### 预期结果

✅ AI 助教消耗助教配额  
✅ AI 内容生成消耗内容配额  
✅ 两者互不影响  
✅ 前端显示数字准确  

## 📝 后续优化建议

1. **统一配额常量**
   - 建议将 "AI 助教提问" 等字符串定义为常量
   - 避免硬编码导致的拼写错误

2. **配额监控**
   - 添加配额使用率监控
   - 异常高消耗告警

3. **降级策略**
   - 当某个功能配额耗尽时，提供更友好的提示
   - 引导用户升级 VIP 或使用其他功能

---

**修复人员**: Antigravity AI  
**修复时间**: 2026-02-15 02:15  
**影响版本**: LearnSphere 2.5.0+  
**相关文档**: `AI_Governance_Enhancement.md`
