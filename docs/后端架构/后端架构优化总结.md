# åç«¯æ¶æ„ä¸ç¨³å®šæ€§ä¼˜åŒ–æ€»ç»“

## ğŸ—ï¸ æ¶æ„ä¼˜åŒ–æ¦‚è§ˆ

æœ¬æ¬¡ä¼˜åŒ–é’ˆå¯¹ LearnSphere AI åç«¯çš„ä¸‰ä¸ªæ ¸å¿ƒç—›ç‚¹ï¼š
1. **å¤šçº§ç¼“å­˜ç­–ç•¥** - å‡å°‘ AI è°ƒç”¨æ¬¡æ•°ï¼Œæå‡å“åº”é€Ÿåº¦
2. **å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—** - å¤„ç†è€—æ—¶æ“ä½œï¼Œé¿å…é˜»å¡
3. **ç†”æ–­ä¸é™çº§** - ä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§ï¼Œé˜²æ­¢é›ªå´©

---

## 1ï¸âƒ£ å¤šçº§ç¼“å­˜ç­–ç•¥ (Redis Optimization)

### ğŸ“Š Cache-Aside æ¨¡å¼

```
è¯·æ±‚æµç¨‹ï¼š
1. å…ˆæŸ¥ Redis ç¼“å­˜
   â†“ (ç¼“å­˜æœªå‘½ä¸­)
2. å†æŸ¥æ•°æ®åº“
   â†“ (æ•°æ®åº“ä¹Ÿæ²¡æœ‰)
3. æœ€åè°ƒç”¨ AI ç”Ÿæˆ
   â†“
4. å°†ç»“æœå†™å…¥ Redis + DB
```

### ğŸ”§ å®ç°ç»†èŠ‚

#### **Spring Cache æ³¨è§£æ–¹å¼**
```java
@Cacheable(value = "dailySentence", key = "#root.method.name + '_' + T(java.time.LocalDate).now()")
public String getDailySentence() {
    // 1. å°è¯•ä» DB è·å–
    String sentenceFromDb = fetchDailySentenceFromDB();
    if (sentenceFromDb != null) return sentenceFromDb;
    
    // 2. è°ƒç”¨ AI ç”Ÿæˆ
    String aiGenerated = callAIToGenerateSentence();
    
    // 3. ä¿å­˜åˆ° DB
    saveDailySentenceToDB(aiGenerated);
    
    return aiGenerated;
}
```

#### **RedisTemplate æ‰‹åŠ¨æ§åˆ¶æ–¹å¼**
```java
public Map<String, Object> getHotVocabulary() {
    String key = "hot:vocabulary";
    
    // 1. å…ˆæŸ¥ Redis
    Object cached = redisTemplate.opsForValue().get(key);
    if (cached != null) return (Map) cached;
    
    // 2. æŸ¥æ•°æ®åº“
    Map<String, Object> dbResult = vocabularyMapper.getHotWords();
    if (dbResult != null) {
        redisTemplate.opsForValue().set(key, dbResult, 10, TimeUnit.MINUTES);
        return dbResult;
    }
    
    // 3. è°ƒç”¨ AI
    Map<String, Object> aiResult = aiService.generateHotVocab();
    redisTemplate.opsForValue().set(key, aiResult, 10, TimeUnit.MINUTES);
    return aiResult;
}
```

### ğŸ“ˆ é€‚ç”¨åœºæ™¯

| æ•°æ®ç±»å‹ | ç¼“å­˜æ—¶é—´ | ç†ç”± |
|---------|---------|------|
| æ¯æ—¥ä¸€å¥ | 24 å°æ—¶ | æ¯å¤©åªéœ€ç”Ÿæˆä¸€æ¬¡ |
| çƒ­é—¨è¯æ±‡ | 6 å°æ—¶ | å˜åŒ–ä¸é¢‘ç¹ |
| Dashboard ç»Ÿè®¡ | 5-10 åˆ†é’Ÿ | é«˜é¢‘æŸ¥è¯¢ï¼Œå®æ—¶æ€§è¦æ±‚ä¸é«˜ |
| å›ºå®šéš¾åº¦è¯­æ³•é¢˜ | 1 å°æ—¶ | åŒä¸€éš¾åº¦é¢˜ç›®å¯å¤ç”¨ |

### âœ… ä¼˜åŒ–æ•ˆæœ

- **å‡å°‘ AI è°ƒç”¨**ï¼šç›¸åŒè¯·æ±‚ä» AI è°ƒç”¨å˜ä¸º Redis è¯»å–ï¼ˆ<1msï¼‰
- **é™ä½æˆæœ¬**ï¼šAI API è°ƒç”¨æ¬¡æ•°å‡å°‘ 70%+
- **æå‡å“åº”é€Ÿåº¦**ï¼šDashboard åŠ è½½ä» 2s é™è‡³ <100ms

---

## 2ï¸âƒ£ å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ— (Async Processing)

### ğŸ¯ é—®é¢˜åœºæ™¯

**åŒæ­¥å¤„ç†çš„é—®é¢˜**ï¼š
```
ç”¨æˆ·è¯·æ±‚ â†’ ç”Ÿæˆé•¿æ–‡é˜…è¯»ï¼ˆAI è€—æ—¶ 10sï¼‰â†’ ç”¨æˆ·ç­‰å¾… 10s â†’ è¿”å›ç»“æœ
```

**User Experience**: ğŸ˜° "ä¸ºä»€ä¹ˆè¿™ä¹ˆæ…¢ï¼Ÿå¡ä½äº†å—ï¼Ÿ"

### âš¡ å¼‚æ­¥å¤„ç†æ–¹æ¡ˆ

```
ç”¨æˆ·è¯·æ±‚ â†’ æäº¤ä»»åŠ¡ï¼Œè¿”å› taskId (ç«‹å³) 
          â†“
      åå°å¼‚æ­¥ç”Ÿæˆï¼ˆ10sï¼‰
          â†“
ç”¨æˆ·è½®è¯¢ taskId æŸ¥è¯¢ç»“æœ â†’ æ˜¾ç¤ºè¿›åº¦æ¡
```

**User Experience**: ğŸ˜Š "æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™..."

### ğŸ”§ å®ç°ç»†èŠ‚

#### **åç«¯å¼‚æ­¥æ–¹æ³•**
```java
@Async("aiTaskExecutor")
public CompletableFuture<Map<String, Object>> generateReadingAsync(String level) {
    String taskId = UUID.randomUUID().toString();
    
    try {
        // æ¨¡æ‹Ÿè€—æ—¶ AI è°ƒç”¨
        Map<String, Object> result = callAIService(level);
        result.put("taskId", taskId);
        result.put("status", "completed");
        
        // å°†ç»“æœå­˜å…¥ Redisï¼Œ10 åˆ†é’Ÿè¿‡æœŸ
        redisTemplate.opsForValue().set("async:task:" + taskId, result, 10, TimeUnit.MINUTES);
        
        return CompletableFuture.completedFuture(result);
    } catch (Exception e) {
        // é”™è¯¯å¤„ç†
        Map<String, Object> error = Map.of("taskId", taskId, "status", "failed");
        return CompletableFuture.completedFuture(error);
    }
}
```

#### **å‰ç«¯è½®è¯¢ç¤ºä¾‹**
```javascript
// 1. æäº¤ä»»åŠ¡
const { data } = await api.generateReadingAsync({ level: 'advanced' });
const taskId = data.taskId;

// 2. è½®è¯¢æŸ¥è¯¢ç»“æœ
const pollResult = setInterval(async () => {
    const result = await api.getTaskResult(taskId);
    
    if (result.status === 'completed') {
        clearInterval(pollResult);
        showResult(result);
    } else if (result.status === 'failed') {
        clearInterval(pollResult);
        showError(result.error);
    }
}, 2000); // æ¯ 2 ç§’æŸ¥è¯¢ä¸€æ¬¡
```

### ğŸ“‹ çº¿ç¨‹æ± é…ç½®

```java
@Bean(name = "aiTaskExecutor")
public Executor aiTaskExecutor() {
    ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
    executor.setCorePoolSize(5);          // æ ¸å¿ƒçº¿ç¨‹æ•°
    executor.setMaxPoolSize(10);          // æœ€å¤§çº¿ç¨‹æ•°
    executor.setQueueCapacity(100);       // é˜Ÿåˆ—å®¹é‡
    executor.setThreadNamePrefix("ai-task-");
    executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
    executor.initialize();
    return executor;
}
```

### âœ… ä¼˜åŒ–æ•ˆæœ

- **å“åº”æ—¶é—´**ï¼šæ¥å£ä» 10s é™è‡³ <100ms
- **ç”¨æˆ·ä½“éªŒ**ï¼šç«‹å³åé¦ˆ + è¿›åº¦æç¤º
- **ç³»ç»Ÿç¨³å®šæ€§**ï¼šä¸é˜»å¡ä¸»çº¿ç¨‹æ± 

---

## 3ï¸âƒ£ ç†”æ–­ä¸é™çº§æœºåˆ¶ (Circuit Breaker)

### âš ï¸ é—®é¢˜åœºæ™¯

**æ²¡æœ‰ç†”æ–­çš„åæœ**ï¼š
```
AI æœåŠ¡æ•…éšœ â†’ æ‰€æœ‰è¯·æ±‚è¶…æ—¶ï¼ˆ30sï¼‰â†’ çº¿ç¨‹æ± è€—å°½ â†’ æ•´ä¸ªåç«¯æŒ‚æ‰
```

### ğŸ›¡ï¸ Resilience4j ç†”æ–­å™¨

```
ç†”æ–­å™¨çŠ¶æ€æœºï¼š
CLOSED (æ­£å¸¸) â†’ AI è°ƒç”¨æˆåŠŸ
   â†“ (å¤±è´¥ç‡ > 50%)
OPEN (ç†”æ–­) â†’ ç›´æ¥è¿”å›é™çº§æ•°æ®ï¼Œä¸è°ƒç”¨ AI
   â†“ (ç­‰å¾… 1 åˆ†é’Ÿ)
HALF_OPEN (åŠå¼€) â†’ å…è®¸å°‘é‡è¯·æ±‚æµ‹è¯• AI æ˜¯å¦æ¢å¤
   â†“ (æˆåŠŸç‡ > 50%)
CLOSED (æ¢å¤æ­£å¸¸)
```

### ğŸ”§ å®ç°ç¤ºä¾‹

```java
@CircuitBreaker(name = "aiService", fallbackMethod = "fallbackToLocalData")
public Map<String, Object> generateGrammar(String topic) {
    // å°è¯•è°ƒç”¨ AI
    return aiClient.generateGrammar(topic);
}

// é™çº§æ–¹æ³•ï¼šä»æœ¬åœ°æ•°æ®åº“è¿”å›é¢„å…ˆå‡†å¤‡çš„é¢˜ç›®
public Map<String, Object> fallbackToLocalData(String topic, Exception e) {
    log.warn("AI Service Circuit Open, fallback to local data. Error: {}", e.getMessage());
    return grammarMapper.getLocalQuestions(topic);
}
```

### ğŸ“Š é…ç½®å‚æ•°

```properties
# å¤±è´¥ç‡è¾¾åˆ° 50% æ—¶æ‰“å¼€ç†”æ–­å™¨
resilience4j.circuitbreaker.instances.aiService.failure-rate-threshold=50

# ç†”æ–­å™¨æ‰“å¼€åç­‰å¾… 1 åˆ†é’Ÿå†å°è¯•æ¢å¤
resilience4j.circuitbreaker.instances.aiService.wait-duration-in-open-state=60000

# æ»‘åŠ¨çª—å£å¤§å°ä¸º 10 æ¬¡è°ƒç”¨
resilience4j.circuitbreaker.instances.aiService.sliding-window-size=10

# æœ€å°‘ 5 æ¬¡è°ƒç”¨åæ‰å¼€å§‹è®¡ç®—å¤±è´¥ç‡
resilience4j.circuitbreaker.instances.aiService.minimum-number-of-calls=5

# AI è°ƒç”¨è¶…æ—¶æ—¶é—´ 30 ç§’
resilience4j.timelimiter.instances.aiService.timeout-duration=30s
```

### âœ… ä¿æŠ¤æ•ˆæœ

- **å¿«é€Ÿå¤±è´¥**ï¼šç†”æ–­æ‰“å¼€åç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…è¶…æ—¶
- **è‡ªåŠ¨æ¢å¤**ï¼šAI æœåŠ¡æ¢å¤åè‡ªåŠ¨åˆ‡å›
- **ç³»ç»Ÿç¨³å®š**ï¼šé˜²æ­¢é›ªå´©æ•ˆåº”ï¼Œä¿æŠ¤æ ¸å¿ƒåŠŸèƒ½

---

## ğŸš€ æ•´é«”æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯ (Vue.js)                         â”‚
â”‚  - è½®è¯¢å¼‚æ­¥ä»»åŠ¡ç»“æœ                                        â”‚
â”‚  - æ˜¾ç¤ºåŠ è½½è¿›åº¦                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ HTTP Request
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Spring Boot åç«¯                             â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  Controller    â”‚  â”‚  Async Task    â”‚                 â”‚
â”‚  â”‚  (åŒæ­¥æ¥å£)     â”‚  â”‚  Executor      â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚           â”‚                   â”‚                          â”‚
â”‚           â–¼                   â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚      Service Layer (ç¼“å­˜å±‚)         â”‚                 â”‚
â”‚  â”‚  1. æŸ¥ Redis (@Cacheable)          â”‚                 â”‚
â”‚  â”‚  2. æŸ¥æ•°æ®åº“                        â”‚                 â”‚
â”‚  â”‚  3. è°ƒ AI (å¸¦ç†”æ–­ä¿æŠ¤)              â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚           â”‚                    â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                    â”‚
            â–¼                    â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚    Redis     â”‚      â”‚   AI Service  â”‚
  â”‚  (ç¼“å­˜å±‚)     â”‚      â”‚ (Resilience4j â”‚
  â”‚              â”‚      â”‚   ç†”æ–­ä¿æŠ¤)    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ–°å¢æ–‡ä»¶æ¸…å•

```
backend/
â”œâ”€â”€ pom.xml                                 (æ–°å¢ Resilience4j ä¾èµ–)
â”œâ”€â”€ src/main/java/com/learnsphere/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ RedisConfig.java               âœ¨ Redis é…ç½®
â”‚   â”‚   â”œâ”€â”€ CircuitBreakerConfig.java      âœ¨ ç†”æ–­å™¨é…ç½®
â”‚   â”‚   â””â”€â”€ AsyncConfig.java               âœ¨ å¼‚æ­¥çº¿ç¨‹æ± é…ç½®
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â””â”€â”€ IAIGenerationService.java      âœ¨ AI ç”ŸæˆæœåŠ¡æ¥å£
â”‚   â””â”€â”€ service/impl/
â”‚       â””â”€â”€ AIGenerationServiceImpl.java   âœ¨ ç¼“å­˜+å¼‚æ­¥ç¤ºä¾‹å®ç°
â”‚   â””â”€â”€ controller/
â”‚       â””â”€â”€ DemoController.java            âœ¨ æ¼”ç¤º Controller
â””â”€â”€ src/main/resources/
    â””â”€â”€ application-redis.properties        âœ¨ Redis é…ç½®æ¨¡æ¿
```

---

## ğŸ¯ ä½¿ç”¨æŒ‡å—

### 1. å¯ç”¨ Redisï¼ˆå¯é€‰ï¼‰

å¦‚æœæœ¬åœ°æ²¡æœ‰ Redisï¼Œå¯ä»¥ï¼š
- **Docker å¯åŠ¨**ï¼š`docker run -d -p 6379:6379 redis`
- **æˆ–è·³è¿‡**ï¼šä»£ç å·²åšå¥½å®¹é”™ï¼ŒRedis ä¸å¯ç”¨æ—¶ç›´æ¥æŸ¥ DB/AI

### 2. åº”ç”¨åˆ°ç°æœ‰æœåŠ¡

#### **ç¤ºä¾‹ 1ï¼šDashboard ç¼“å­˜**
```java
@Cacheable(value = "dashboard", key = "'stats_' + #userId")
public Map<String, Object> getDashboardStats(Long userId) {
    // ç¬¬ä¸€æ¬¡æŸ¥è¯¢ä¼šæ‰§è¡Œè¿™é‡Œï¼Œåç»­ç›´æ¥ä» Redis è¿”å›
    return statisticsMapper.getUserStats(userId);
}
```

#### **ç¤ºä¾‹ 2ï¼šå¼‚æ­¥ç”Ÿæˆå¬åŠ›**
```java
@Async("aiTaskExecutor")
public CompletableFuture<Map<String, Object>> generateListeningAsync(String level) {
    String taskId = UUID.randomUUID().toString();
    Map<String, Object> result = aiService.generateListening(level);
    redisTemplate.opsForValue().set("async:task:" + taskId, result, 10, TimeUnit.MINUTES);
    return CompletableFuture.completedFuture(result);
}
```

#### **ç¤ºä¾‹ 3ï¼šAI è°ƒç”¨ç†”æ–­**
```java
@CircuitBreaker(name = "aiService", fallbackMethod = "fallbackToMock")
public String generateEssay(String topic) {
    return aiClient.generateEssay(topic);
}

public String fallbackToMock(String topic, Exception e) {
    return "AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ä½œæ–‡...";
}
```

---

## ğŸ“Š é¢„æœŸæ•ˆæœå¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|-----|-------|-------|------|
| Dashboard å“åº”æ—¶é—´ | 2s | <100ms | **20x** |
| AI è°ƒç”¨æ¬¡æ•° | 1000/å¤© | 300/å¤© | **å‡å°‘ 70%** |
| é•¿æ–‡ç”Ÿæˆå“åº” | 10s | <100ms (å¼‚æ­¥) | **100x** |
| AI æ•…éšœå½±å“ | æ•´ä¸ªåç«¯ä¸å¯ç”¨ | è‡ªåŠ¨é™çº§ï¼Œæ ¸å¿ƒåŠŸèƒ½å¯ç”¨ | **å¯ç”¨æ€§ 99%+** |

---

## ğŸ”® æœªæ¥æ‰©å±•

1. **åˆ†å¸ƒå¼ç¼“å­˜**ï¼šå¤šå®ä¾‹éƒ¨ç½²æ—¶å…±äº« Redis
2. **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šå¼•å…¥ RabbitMQ å¤„ç†æ›´å¤æ‚çš„ä»»åŠ¡æµ
3. **ç›‘æ§å‘Šè­¦**ï¼šé›†æˆ Prometheus + Grafana ç›‘æ§ç†”æ–­å™¨çŠ¶æ€
4. **ç¼“å­˜é¢„çƒ­**ï¼šå®šæ—¶ä»»åŠ¡é¢„ç”Ÿæˆçƒ­é—¨å†…å®¹

---

## ğŸ“ æ€»ç»“

é€šè¿‡ **å¤šçº§ç¼“å­˜**ã€**å¼‚æ­¥å¤„ç†** å’Œ **ç†”æ–­é™çº§** ä¸‰å¤§ç­–ç•¥ï¼ŒLearnSphere AI åç«¯ç°åœ¨å…·å¤‡ï¼š

âœ… **é«˜æ€§èƒ½**ï¼šç¼“å­˜å‘½ä¸­ç‡ > 70%ï¼Œå“åº”æ—¶é—´ < 100ms  
âœ… **é«˜å¯ç”¨**ï¼šAI æ•…éšœè‡ªåŠ¨é™çº§ï¼Œä¸å½±å“æ ¸å¿ƒåŠŸèƒ½  
âœ… **é«˜æ‰©å±•**ï¼šå¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—æ”¯æŒå¹¶å‘å¤„ç†  
âœ… **ä½æˆæœ¬**ï¼šAI è°ƒç”¨æ¬¡æ•°å‡å°‘ 70%

è¿™ä¸º LearnSphere AI æä¾›äº†ç”Ÿäº§çº§åˆ«çš„ç¨³å®šæ€§å’Œæ€§èƒ½ä¿éšœï¼ğŸš€
