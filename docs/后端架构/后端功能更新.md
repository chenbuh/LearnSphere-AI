# 后端功能更新说明 - 敏感词库与通知服务

本文档记录了 LearnSphere AI 后端在内容安全管理与用户通知模块方面的最新更新，旨在提供完整的实现记录与使用参考。

## 1. 敏感词数据库直连增强

为了使得敏感词过滤规则更易于管理和动态更新，后端内容管理服务（`ContentManagementService`）的敏感词初始化方式已经从纯硬编码转变为从数据库加载。

### 实现细节
- **新增实体**: `com.learnsphere.entity.SensitiveWord`，映射到数据库中存储的一级敏感词表 `sensitive_word`。
- **新增数据访问**: `com.learnsphere.mapper.SensitiveWordMapper`，使用 MyBatis-Plus 的 `BaseMapper` 进行数据库查询（例如 `selectList(null)`）。
- **流程改变**: 在 `ContentManagementServiceImpl` 启动时的 `@PostConstruct` `init()` 方法中，首先加载默认硬编码的几个高危词汇（如：暴力、色情等），随后查询 `sensitive_word` 表将所有自定义敏感词补充到内存驱动的 `SensitiveWordFilter` 中。

> **注意**: 请确保在 MySQL 数据库中执行相关建表脚本来创建 `sensitive_word` 表，以防查询不到报错。此异常只作日志告警，不影响服务的正常启动和核心过滤（硬编码词依然有效）。

## 2. 批量通知服务重构

针对用户批量通知业务所需，增加了一个支持多渠道通知发送的可插拔服务结构。

### 实现细节
- **新增接口**: `com.learnsphere.service.NotificationService`，定义了发送邮件和站内信的规范 `sendEmail` 和 `sendInApp`。
- **基础实现**: `com.learnsphere.service.impl.NotificationServiceImpl`，目前通过日志打印形式实现。后续可以轻松将其替换为真实的 `JavaMailSender` 或第三方通信 SDK（例如阿里云邮件/短信服务，WebSocket 实时推送等）。
    - **业务集成**: 更新了 `UserServiceImpl` 中的 `batchNotifyUsers` 逻辑，结合 `NotificationService` 完成遍历群发。

## 3. 管理后台管理增强

为了能够更直观地管理由于第一点产生的敏感词库，在原来的“敏感审计”页面（`SensitiveAudit.vue` 及对应后端 API）中新引进了增删改查视图。

### 后端 API (/api/admin/sensitive)
- `GET /words`: 分页获取存在数据库中的有效敏感词。
- `POST /words`: 手动插入新敏感词，附带针对重复情况的安全错误包裹。
- `DELETE /words/{id}`: 删除某个指定的敏感词。
- `POST /words/reload`: 热更手动加载当前数据库内完整的敏感词列表，通过调用 `IContentManagementService.reloadSensitiveWords()` 推送到过滤器中。

### 管理后台前端 (admin-vue)
主要更新在 `src/views/SensitiveAudit.vue`。采用了 `n-tabs` 将原有的"审计拦截日志"和新的"敏感词库管理"分为两个页面 Tab。
引入了新的接口封装到 `/api/admin.js` 当中，方便管理人员通过界面直接操控后台词库，不需要再操作数据库脚本。

## 3. 部署与测试须知

- 若要在本地或生产环境生效上述安全词屏蔽，可在后台手动或直接通过 SQL 往 `sensitive_word` 表插入记录（通过 `id` 和 `word`）。
- 测试批量触发提醒时，可观察 Spring Boot 后端日志，以查看是否按照预期输出 `[Notification]` 的标签日志记录。
