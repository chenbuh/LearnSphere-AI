# 后台管理与 AI 治理功能实现文档

## 1. 功能概述

后台管理模块不仅包含传统的用户管理和内容管理，核心亮点在于 **AI 治理 (AI Governance)**。管理员可以实时监控 AI 服务的调用情况、Token 消耗成本、模型响应性能，并对敏感内容进行审计。

## 2. 数据库设计

### 核心表：`ai_generation_log`
记录每一次 AI 调用的详细元数据。

```sql
CREATE TABLE ai_generation_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT,
    action_type VARCHAR(50),       -- GENERATE_READING, EVALUATE_SPEAKING ...
    model_name VARCHAR(50),        -- qwen-plus, qwen-turbo ...
    prompt_preview VARCHAR(500),   -- 提示词快照 (截断)
    status VARCHAR(20),            -- SUCCESS, FAIL
    error_message TEXT,
    duration_ms BIGINT,            -- 耗时 (毫秒)
    input_tokens INT,              -- 输入 Token 数
    output_tokens INT,             -- 输出 Token 数
    total_tokens INT,              -- 总消耗
    create_time DATETIME
);
```

## 3. 后端实现 (`AdminController.java`)

### 3.1 统计 API (`/api/admin/ai/stats`)
聚合查询日志表，返回全景监控数据：
*   **总调用量 & 成功率**
*   **Token 消耗**: 计算 `SUM(total_tokens)` 及 24小时增量。
*   **性能监控**: 计算 `AVG(duration_ms)`。

### 3.2 日志记录 AOP/Service
在 `AIGenerationServiceImpl` 的每个 AI 调用方法中（通常在 `finally` 块），自动提取 `GenerationResult` 中的 usage 信息，并异步写入数据库，确保不阻塞主业务流程。

## 4. 前端实现 (`AIGovernance.vue`)

### 4.1 监控仪表盘
*   **实时数据卡片**: 展示 Token 消耗、平均响应时间等关键指标，采用数字滚动动画。
*   **调用趋势图**: 使用 ECharts 渲染最近 14 天的 API 调用量和 Token 消耗趋势。

### 4.2 日志审计列表
*   分页展示 AI 调用日志。
*   支持按 状态 (成功/失败)、类型、用户 ID 进行筛选。
*   **失败重试**: (规划中) 对失败的生成任务进行手动重试。

## 5. 价值与意义
*   **成本控制**: 通过 Token 监控精确掌握 AI API 的开销。
*   **性能优化**: 识别响应慢的模型或时段。
*   **故障排查**: 快速定位 AI 生成失败的原因（如 Prompt 过长、API 限流等）。
