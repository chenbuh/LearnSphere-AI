<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.learnsphere.mapper.KnowledgeGraphMapper">

    <!-- 根据知识点获取信息 -->
    <select id="getByTopic" resultType="com.learnsphere.entity.KnowledgeGraph">
        SELECT * FROM knowledge_graph
        WHERE topic = #{topic}
        AND deleted = 0
        LIMIT 1
    </select>

    <!-- 获取相关知识点 -->
    <select id="getRelatedTopics" resultType="com.learnsphere.entity.KnowledgeGraph">
        SELECT kg.* 
        FROM knowledge_graph kg
        WHERE kg.deleted = 0
        AND (
            kg.topic IN (
                SELECT JSON_UNQUOTE(JSON_EXTRACT(related_topics, CONCAT('$[', numbers.n, ']')))
                FROM knowledge_graph,
                    (SELECT 0 n UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 
                     UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) numbers
                WHERE topic = #{topic}
                AND deleted = 0
                AND JSON_EXTRACT(related_topics, CONCAT('$[', numbers.n, ']')) IS NOT NULL
            )
            OR kg.category = (SELECT category FROM knowledge_graph WHERE topic = #{topic} AND deleted = 0 LIMIT 1)
        )
        AND kg.topic != #{topic}
        ORDER BY kg.difficulty_level
        LIMIT 5
    </select>

    <!-- 获取某个类别的所有知识点 -->
    <select id="getByCategory" resultType="com.learnsphere.entity.KnowledgeGraph">
        SELECT * FROM knowledge_graph
        WHERE category = #{category}
        AND deleted = 0
        ORDER BY difficulty_level, topic
    </select>

</mapper>
