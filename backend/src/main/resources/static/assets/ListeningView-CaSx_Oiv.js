import{a as X}from"./ai-sA4E8Qum.js";import{_ as ye,f as $,l as ge}from"./index-CZUTEx94.js";import{a6 as _e,r as y,w as O,j as q,S as he,aO as me,I as d,z as c,F as a,s as n,q as o,u as l,U as W,$ as B,J as k,a2 as w,a3 as j,X as u,V as x,K as C,H as h,p as Y,a1 as be,L as F,an as ke,ao as we,aB as Ce,ad as J,au as qe,_ as Se,ae as Ne,aA as ze}from"./naive-ui-CN0IOFzZ.js";import{a0 as Pe,y as Le,a3 as Ae,a4 as Te}from"./lucide-DtS2HtB5.js";import"./echarts-5QPu3XI4.js";const $e={class:"listening-view"},Be={key:0,class:"setup-container"},xe={class:"config-item"},Ve={class:"type-grid"},Ee=["onClick"],Qe={class:"icon"},Me={class:"label"},Ue={class:"config-item"},He={class:"config-item"},je={key:0,class:"empty-history"},De={key:2,class:"pagination-wrapper mt-4"},Ge={key:1,class:"test-container"},Oe={class:"test-header"},Fe={class:"passage-title"},Je={class:"timer-box"},Ie={class:"count"},Re={class:"test-layout"},Ke={class:"main-content"},Xe={class:"play-btn"},We={class:"audio-info"},Ye={class:"question-header"},Ze={class:"q-num"},et={class:"options-grid"},tt=["onClick"],st={class:"option-idx"},at={class:"option-text"},lt={class:"nav-actions"},nt={class:"side-navigation"},ot={class:"group-title"},it={class:"num-grid"},ut=["onClick"],rt={key:2,class:"result-container"},ct={class:"score-circle"},dt={class:"val"},vt={__name:"ListeningView",setup(pt){const S=_e(),m=y("setup"),N=y(!1),v=y([]),r=y(0),p=y(0),g=y({}),V=y(0),E=y([]),b=y(!1),Q=y(1),M=y(10),z=y(0);O([Q,M],()=>{D()});const _=y({examType:"ted",mode:"extensive",difficulty:"normal",count:3}),Z=[{label:"TED æ¼”è®²",value:"ted",icon:"ğŸ¤"},{label:"BBC æ–°é—»",value:"bbc",icon:"ğŸŒ"},{label:"æ—¥å¸¸å¯¹è¯",value:"dialog",icon:"ğŸ’¬"},{label:"æ‰˜ç¦å¬åŠ›",value:"toefl",icon:"ğŸ—½"},{label:"é›…æ€å¬åŠ›",value:"ielts",icon:"ğŸ‡¬ğŸ‡§"},{label:"è‹±è¯­æ•…äº‹",value:"stories",icon:"ğŸ“–"}],ee=[{label:"æ…¢é€Ÿ",value:"slow"},{label:"æ ‡å‡†",value:"normal"},{label:"å¿«é€Ÿ",value:"fast"}],te=[3,5,8,10],P=q(()=>v.value[r.value]||null),I=q(()=>{const e=P.value;return!e||!e.questions?null:e.questions[p.value]}),U=q(()=>v.value.reduce((e,t)=>e+(t.questions?.length||0),0)),H=q(()=>{let e=0;for(let t=0;t<r.value;t++)e+=v.value[t]?.questions?.length||0;return e+p.value}),se=q(()=>U.value===0?0:(H.value+1)/U.value*100),ae=q(()=>m.value==="testing"&&Object.keys(g.value).length>0),le=q(()=>E.value),R=e=>{if(ae.value)return e.preventDefault(),e.returnValue="ç»ƒä¹ æ­£åœ¨è¿›è¡Œä¸­ï¼Œç¦»å¼€å°†ä¸¢å¤±è¿›åº¦ã€‚",e.returnValue};he(()=>{D(),window.addEventListener("beforeunload",R)}),me(()=>{window.removeEventListener("beforeunload",R),L()}),O(r,()=>{L()});const D=async()=>{try{const e=await X.getListeningHistory(Q.value,M.value);e.code===200&&(e.data.records?(E.value=e.data.records,z.value=e.data.total):(E.value=e.data||[],z.value=E.value.length))}catch(e){$.error("Failed to fetch history",e)}},ne=e=>{if(e)try{let t=e.questions;if(typeof t=="string")try{t=JSON.parse(t)}catch(s){$.error("Failed to parse questions JSON",s),t=[]}v.value=[{id:e.id||Date.now(),title:e.title||"Historical Material",script:e.script||"",questions:Array.isArray(t)?t:[]}],r.value=0,p.value=0,g.value={0:{}},m.value="testing",S.success(`å·²é‡æ–°åŠ è½½: ${e.title}`)}catch(t){S.error("åŠ è½½å†å²æ•°æ®å¤±è´¥"),$.error("Load Material Error",t)}},oe=async()=>{N.value=!0;try{const e=await X.generateListening({type:_.value.examType,difficulty:_.value.difficulty,count:_.value.count});e.code===200&&e.data&&(e.data.passages?v.value=e.data.passages:v.value=[{id:1,title:e.data.title||"Passage 1",script:e.data.script||"",questions:e.data.questions||[]}],r.value=0,p.value=0,g.value={},v.value.forEach((t,s)=>{g.value[s]={}}),m.value="testing",S.success(`å¬åŠ›ç”ŸæˆæˆåŠŸï¼šå…± ${v.value.length} ç¯‡`),D())}catch(e){$.error("Generation Error",e),S.error("ç”Ÿæˆå¤±è´¥")}finally{N.value=!1}},ie=()=>{const e=P.value;if(!(!e||!e.script)&&"speechSynthesis"in window){window.speechSynthesis.cancel();const t=new SpeechSynthesisUtterance(e.script);t.lang="en-US",t.rate=_.value.difficulty==="slow"?.8:_.value.difficulty==="fast"?1.2:1,t.onstart=()=>{b.value=!0},t.onend=()=>{b.value=!1},t.onerror=()=>{b.value=!1},window.speechSynthesis.speak(t)}},L=()=>{"speechSynthesis"in window&&window.speechSynthesis.cancel(),b.value=!1},ue=e=>{g.value[r.value]||(g.value[r.value]={}),g.value[r.value][p.value]=e},re=()=>{const e=P.value;e&&(p.value<e.questions.length-1?p.value++:r.value<v.value.length-1?(r.value++,p.value=0,S.info(`è¿›å…¥ä¸‹ä¸€ç¯‡: ${P.value.title}`)):ve())},ce=()=>{if(p.value>0)p.value--;else if(r.value>0){r.value--;const e=v.value[r.value];p.value=(e.questions?.length||1)-1}},de=(e,t)=>{r.value=e,p.value=t},ve=async()=>{N.value=!0;try{let e=0,t=0;for(let s=0;s<v.value.length;s++){const i=v.value[s],A=g.value[s]||{};for(let f=0;f<i.questions.length;f++){const T=i.questions[f],G=A[f]===T.correct;G&&e++,t++,await ge.createRecord({contentId:T.id||s*100+f,contentType:"listening",isCorrect:G?1:0,answer:A[f]!==void 0?String(A[f]):"-1",correctAnswer:String(T.correct),masteryLevel:G?3:1,originalContent:JSON.stringify({passage:i.title,question:T.question,script:i.script})}).catch(fe=>$.error("Save error",fe))}}V.value=t>0?Math.round(e/t*100):0,m.value="result"}finally{N.value=!1}},K=()=>{L(),m.value="setup",v.value=[],g.value={}};O(m,e=>{e!=="testing"&&L()});const pe=(e,t)=>{let s=1;for(let i=0;i<e;i++)s+=v.value[i].questions?.length||0;return s+t};return(e,t)=>(c(),d("div",$e,[m.value==="setup"?(c(),d("div",Be,[t[8]||(t[8]=a("div",{class:"hero-section"},[a("h1",null,"AI å¬åŠ›ç‰¹è®­"),a("p",null,"åŸºäºå…ˆè¿› AI æŠ€æœ¯çš„æ²‰æµ¸å¼è‹±è¯­å¬åŠ›ç¯å¢ƒ")],-1)),n(l(Se),{"x-gap":"24","y-gap":"24",cols:"1 700:2",responsive:"screen"},{default:o(()=>[n(l(W),{span:"1"},{default:o(()=>[n(l(B),{class:"config-card",title:"é…ç½®æ‚¨çš„ç”Ÿæˆæ–¹æ¡ˆ",bordered:!1},{footer:o(()=>[n(l(C),{type:"primary",block:"",size:"large",loading:N.value,onClick:oe},{default:o(()=>[...t[6]||(t[6]=[h(" ç”Ÿæˆå¬åŠ›ææ–™ ",-1)])]),_:1},8,["loading"])]),default:o(()=>[a("div",xe,[t[3]||(t[3]=a("label",null,"ææ–™ç±»å‹",-1)),a("div",Ve,[(c(),d(k,null,w(Z,s=>a("div",{key:s.value,class:j(["type-btn",{active:_.value.examType===s.value}]),onClick:i=>_.value.examType=s.value},[a("span",Qe,u(s.icon),1),a("span",Me,u(s.label),1)],10,Ee)),64))])]),a("div",Ue,[t[4]||(t[4]=a("label",null,"ç¯‡ç« æ•°é‡",-1)),n(l(x),null,{default:o(()=>[(c(),d(k,null,w(te,s=>n(l(C),{key:s,size:"small",type:_.value.count===s?"primary":"default",onClick:i=>_.value.count=s},{default:o(()=>[h(u(s)+" ç¯‡ ",1)]),_:2},1032,["type","onClick"])),64))]),_:1})]),a("div",He,[t[5]||(t[5]=a("label",null,"è¯­é€Ÿæ§åˆ¶",-1)),n(l(x),null,{default:o(()=>[(c(),d(k,null,w(ee,s=>n(l(C),{key:s.value,size:"small",type:_.value.difficulty===s.value?"primary":"default",onClick:i=>_.value.difficulty=s.value},{default:o(()=>[h(u(s.label),1)]),_:2},1032,["type","onClick"])),64))]),_:1})])]),_:1})]),_:1}),n(l(W),{span:"1"},{default:o(()=>[n(l(B),{class:"history-card",title:"ç”Ÿæˆè®°å½•",bordered:!1},{default:o(()=>[z.value===0?(c(),d("div",je,[n(l(F),{component:l(Pe),size:"40"},null,8,["component"]),t[7]||(t[7]=a("p",null,"æš‚æ— å†å²çºªå½•",-1))])):(c(),Y(l(ke),{key:1,hoverable:"",clickable:""},{default:o(()=>[(c(!0),d(k,null,w(le.value,s=>(c(),Y(l(we),{key:s.id,onClick:i=>ne(s),style:{cursor:"pointer"}},{default:o(()=>[n(l(Ce),{title:s.title},{description:o(()=>[n(l(x),null,{default:o(()=>[n(l(J),{size:"small",type:"info",bordered:!1},{default:o(()=>[h(u(s.type),1)]),_:2},1024),n(l(J),{size:"small",type:"success",bordered:!1},{default:o(()=>[h(u(s.difficulty),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["title"])]),_:2},1032,["onClick"]))),128))]),_:1})),z.value>0?(c(),d("div",De,[n(l(qe),{page:Q.value,"onUpdate:page":t[0]||(t[0]=s=>Q.value=s),"item-count":z.value,"page-size":M.value,"show-size-picker":"","page-sizes":[10,20,30],"onUpdate:pageSize":t[1]||(t[1]=s=>M.value=s)},null,8,["page","item-count","page-size"])])):be("",!0)]),_:1})]),_:1})]),_:1})])):m.value==="testing"?(c(),d("div",Ge,[a("div",Oe,[n(l(C),{quaternary:"",circle:"",onClick:K},{icon:o(()=>[n(l(F),{component:l(Le)},null,8,["component"])]),_:1}),a("div",Fe,[a("h2",null,u(P.value?.title),1),n(l(J),{size:"small",type:"primary"},{default:o(()=>[h("Passage "+u(r.value+1)+" / "+u(v.value.length),1)]),_:1})]),a("div",Je,[n(l(Ne),{type:"circle",percentage:se.value,"show-indicator":!1,width:40},null,8,["percentage"]),a("span",Ie,u(H.value+1)+" / "+u(U.value),1)])]),a("div",Re,[a("div",Ke,[a("div",{class:"audio-block",onClick:t[2]||(t[2]=s=>b.value?L():ie())},[a("div",{class:j(["playback-visualizer",{isPlaying:b.value}])},[(c(),d(k,null,w(8,s=>a("div",{key:s,class:"bar"})),64))],2),a("div",Xe,[n(l(F),{component:b.value?l(Ae):l(Te),size:"48"},null,8,["component"])]),a("div",We,[a("h4",null,u(b.value?"éŸ³é¢‘æ’­æ”¾ä¸­...":"ç‚¹å‡»æ’­æ”¾å½“å‰ç¯‡ç« éŸ³é¢‘"),1),a("p",null,"Passage "+u(r.value+1)+" æ­£åœ¨æœ—è¯»",1)])]),n(l(B),{class:"question-card",bordered:!1},{default:o(()=>[a("div",Ye,[a("span",Ze,"Question "+u(H.value+1),1),a("h3",null,u(I.value?.question),1)]),a("div",et,[(c(!0),d(k,null,w(I.value?.options,(s,i)=>(c(),d("div",{key:i,class:j(["option-item",{selected:g.value[r.value]?.[p.value]===i}]),onClick:A=>ue(i)},[a("span",st,u(String.fromCharCode(65+i)),1),a("span",at,u(s),1)],10,tt))),128))]),a("div",lt,[n(l(x),{justify:"space-between",style:{width:"100%"}},{default:o(()=>[n(l(C),{secondary:"",onClick:ce,disabled:r.value===0&&p.value===0},{default:o(()=>[...t[9]||(t[9]=[h(" ä¸Šä¸€é¢˜ ",-1)])]),_:1},8,["disabled"]),n(l(C),{type:"primary",onClick:re},{default:o(()=>[h(u(H.value===U.value-1?"æäº¤è¯•å·":"ä¸‹ä¸€é¢˜"),1)]),_:1})]),_:1})])]),_:1})]),a("div",nt,[n(l(B),{title:"é¢˜ç›®å¯¼èˆª",bordered:!1,size:"small"},{default:o(()=>[(c(!0),d(k,null,w(v.value,(s,i)=>(c(),d("div",{key:i,class:"nav-group"},[a("div",ot,"Passage "+u(i+1),1),a("div",it,[(c(!0),d(k,null,w(s.questions,(A,f)=>(c(),d("div",{key:f,class:j(["num-box",{active:i===r.value&&f===p.value,answered:g.value[i]?.[f]!==void 0}]),onClick:T=>de(i,f)},u(pe(i,f)),11,ut))),128))])]))),128))]),_:1})])])])):(c(),d("div",rt,[n(l(B),{class:"result-card",bordered:!1},{default:o(()=>[n(l(ze),{status:"success",title:`ç»ƒä¹ å·²å®Œæˆ! å¾—åˆ†: ${V.value}`,description:V.value>=60?"è¡¨ç°ä¸é”™ï¼Œç»§ç»­ä¿æŒï¼":"è¿˜éœ€è¦å¤šåŠ ç»ƒä¹ ï¼ŒåŠ æ²¹ï¼"},{icon:o(()=>[a("div",ct,[a("span",dt,u(V.value),1)])]),footer:o(()=>[n(l(x),{justify:"center"},{default:o(()=>[n(l(C),{type:"primary",onClick:K},{default:o(()=>[...t[10]||(t[10]=[h("é‡æ–°å¼€å§‹é¡¹ç›®",-1)])]),_:1}),n(l(C),{secondary:""},{default:o(()=>[...t[11]||(t[11]=[h("æŸ¥çœ‹è¯¦ç»†è§£æ",-1)])]),_:1})]),_:1})]),_:1},8,["title","description"])]),_:1})]))]))}},mt=ye(vt,[["__scopeId","data-v-d0d91aa8"]]);export{mt as default};
