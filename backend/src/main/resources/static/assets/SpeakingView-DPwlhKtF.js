import{a as V}from"./ai-sA4E8Qum.js";import{_ as ne,l as re}from"./index-CZUTEx94.js";import{ae as ce,a0 as J,$ as ue,af as de,a3 as pe,a4 as ve,m as ge}from"./lucide-DtS2HtB5.js";import{a6 as fe,r as v,w as ye,j as me,S as _e,ag as he,I as c,z as n,a1 as x,F as s,s as l,q as i,H as d,u as t,L as w,J as N,a2 as R,a3 as K,X as r,K as A,$ as P,p as D,U,ad as I,_ as $,au as Q,V as W,aA as be,ae as B,an as xe,ao as ke}from"./naive-ui-CN0IOFzZ.js";import"./echarts-5QPu3XI4.js";const we={class:"page-container"},Se={key:0,class:"page-header"},ze={key:1,class:"setup-container"},Ce={class:"setting-section"},Te={class:"options-grid"},Ne=["onClick"],Re={class:"option-label"},Ie={class:"option-desc"},Ae={class:"setting-section mt-8"},Pe={key:0,class:"history-section mt-12"},De={class:"section-title"},Le=["onClick"],Fe={class:"history-card-header"},Ue={class:"topic-title"},Ee={class:"topic-date text-xs text-gray-500 mt-2"},Ve={key:0,class:"pagination-wrapper mt-6"},$e={key:2,class:"practice-container"},Be={class:"mb-4"},He={class:"text-xl font-bold mb-4 text-white"},Me={class:"question-box p-4 bg-white/5 rounded-lg mb-4 text-lg leading-relaxed text-gray-200"},je={class:"tips-section"},qe={class:"recorder-ui flex flex-col items-center justify-center h-full min-h-[400px]"},Oe={key:0,class:"ripple"},Ge={key:1,class:"ripple delay-1"},Ye={class:"timer text-4xl font-mono mb-8 text-white font-bold"},Je={class:"controls mb-8"},Ke={class:"transcript-preview w-full p-4 bg-black/20 rounded-lg text-gray-400 text-sm h-32 overflow-y-auto"},Qe={class:"w-full mt-4"},We={key:3,class:"result-container"},Xe={class:"stat-item text-center"},Ze={class:"text-lg font-bold"},et={class:"stat-item text-center"},tt={class:"text-lg font-bold"},st={class:"stat-item text-center"},at={class:"text-lg font-bold"},lt={class:"feedback-text text-lg text-gray-200 mb-6 p-4 bg-white/5 rounded-lg"},ot={class:"text-indigo-400 mb-2 flex items-center gap-2"},it={class:"mt-8 text-center"},nt={key:0,class:"history-section mt-12"},rt={class:"section-title"},ct=["onClick"],ut={class:"history-card-header"},dt={class:"topic-title"},pt={key:0,class:"pagination-wrapper mt-6"},vt={__name:"SpeakingView",setup(gt){const m=fe(),g=v("setup"),S=v(!1),_=v(null),f=v(!1),y=v(""),h=v(0);let E=null,p=null;const u=v(null),L=v([]),z=v(1),C=v(6),b=v(0);ye([z,C],()=>{M()});const F=v({type:"ielts_part2",difficulty:"normal"}),X=[{label:"IELTS Part 1",value:"ielts_part1",desc:"Short Q&A"},{label:"IELTS Part 2",value:"ielts_part2",desc:"Topic Card (2 mins)"},{label:"Business",value:"business",desc:"Meeting / Negotiation"},{label:"Daily Life",value:"daily",desc:"Travel, Food, Hobby"},{label:"Debate",value:"debate",desc:"Agree or Disagree"}],Z=(o,e)=>{F.value[o]=e},H=me(()=>L.value);_e(()=>{M()});const M=async()=>{try{const o=await V.getSpeakingHistory(z.value,C.value);o.code===200&&(o.data.records?(L.value=o.data.records,b.value=o.data.total):(L.value=o.data||[],b.value=L.value.length))}catch(o){console.error("Failed to fetch speaking history",o)}},j=o=>{_.value=o,g.value="practice",y.value="",h.value=0,m.success(`已加载: ${o.topic||o.title}`)},ee=async()=>{S.value=!0;try{const o=await V.generateSpeaking({type:F.value.type,difficulty:F.value.difficulty});o.code===200&&o.data?(_.value=o.data,g.value="practice",y.value="",h.value=0,m.success("Topic generated!")):m.error("Failed to generate topic")}catch(o){console.error(o),_.value={title:"Describe a traditional festival",question:"Describe a traditional festival in your country. You should say: when it is celebrated, what people do, what you enjoy about it, and explain why it is important.",tips:["Use present tense","Mention colors and food","Explain cultural significance"],keywords:["Celebration","Tradition","Atmosphere","Customs"]},g.value="practice",y.value="",h.value=0}finally{S.value=!1}},te=()=>{if("webkitSpeechRecognition"in window||"SpeechRecognition"in window){const o=window.SpeechRecognition||window.webkitSpeechRecognition;p=new o,p.continuous=!0,p.interimResults=!0,p.lang="en-US",p.onresult=e=>{let a="",T="";for(let k=e.resultIndex;k<e.results.length;++k)e.results[k].isFinal?T+=e.results[k][0].transcript:a+=e.results[k][0].transcript;const ie=Array.from(e.results).map(k=>k[0].transcript).join("");y.value=ie},p.onerror=e=>{console.error("Speech recognition error",e.error),f.value&&q(),m.error("Speech recognition error: "+e.error)}}else m.warning("Browser does not support Speech Recognition. Please type your response instead.")},se=()=>{f.value?q():ae()},ae=()=>{if(p||te(),p)try{p.start(),f.value=!0,O()}catch(o){console.error(o)}else f.value=!0,O(),m.info("Simulating recording (No Speech API)")},q=()=>{p&&p.stop(),f.value=!1,G()},O=()=>{clearInterval(E),E=setInterval(()=>{h.value++},1e3)},G=()=>{clearInterval(E)},le=o=>{const e=Math.floor(o/60).toString().padStart(2,"0"),a=(o%60).toString().padStart(2,"0");return`${e}:${a}`};he(()=>{G(),p&&p.stop()});const oe=async()=>{if(!y.value&&h.value<5){m.warning("Please say something more substantial.");return}S.value=!0;try{const o=await V.evaluateSpeaking({topic:_.value.title,transcription:y.value||"(No speech detected, user submitted empty)"});if(o.code===200&&o.data){u.value=o.data,g.value="result",m.success("Evaluation complete");try{await re.createRecord({contentType:"speaking",contentId:0,isCorrect:u.value.score>60?1:0,answer:y.value,correctAnswer:"N/A",score:u.value.score,masteryLevel:Math.floor(u.value.score/20),originalContent:JSON.stringify({topic:_.value,feedback:u.value})})}catch(e){console.error("Failed to save record",e)}}else m.error("Evaluation failed")}catch(o){console.error(o),u.value={score:75,fluency:70,vocabulary:80,grammar:75,relevance:80,feedback:"Overall good attempt. You addressed the prompt well. Try to reduce hesitation.",suggestions:["Use more transitional phrases","Practice past tense verbs"]},g.value="result"}finally{S.value=!1}},Y=()=>{g.value="setup",y.value="",h.value=0,u.value=null};return(o,e)=>(n(),c("div",we,[g.value==="setup"?(n(),c("div",Se,[...e[4]||(e[4]=[s("h1",null,"AI 口语陪练",-1),s("p",null,"模拟真实雅思/托福口语考试场景，AI 实时听音纠错",-1)])])):x("",!0),g.value==="setup"?(n(),c("div",ze,[l(t(P),{class:"setup-card",bordered:!1,size:"huge"},{default:i(()=>[s("div",Ce,[s("h3",null,[l(t(w),{component:t(ce),color:"#fdba74",class:"mr-2"},null,8,["component"]),e[5]||(e[5]=d(" 选择话题类型",-1))]),s("div",Te,[(n(),c(N,null,R(X,a=>s("div",{key:a.value,class:K(["option-card",{active:F.value.type===a.value}]),onClick:T=>Z("type",a.value)},[s("div",Re,r(a.label),1),s("div",Ie,r(a.desc),1)],10,Ne)),64))])]),s("div",Ae,[l(t(A),{type:"primary",size:"large",block:"",round:"",class:"start-btn",loading:S.value,onClick:ee},{default:i(()=>[...e[6]||(e[6]=[d(" 开始练习 ",-1)])]),_:1},8,["loading"])])]),_:1}),b.value>0?(n(),c("div",Pe,[s("div",De,[l(t(w),{component:t(J)},null,8,["component"]),e[7]||(e[7]=d(" 最近生成话题 ",-1))]),l(t($),{"x-gap":"20","y-gap":"20",cols:"1 600:2 1200:3"},{default:i(()=>[(n(!0),c(N,null,R(H.value,a=>(n(),D(t(U),{key:a.id},{default:i(()=>[s("div",{class:"history-card",onClick:T=>j(a)},[s("div",Fe,[l(t(I),{size:"small",type:"warning",bordered:!1},{default:i(()=>[d(r(a.type),1)]),_:2},1024),l(t(I),{size:"tiny",bordered:!1},{default:i(()=>[d(r(a.difficulty),1)]),_:2},1024)]),s("h4",Ue,r(a.topic),1),s("div",Ee,r(new Date(a.createTime).toLocaleDateString()),1)],8,Le)]),_:2},1024))),128))]),_:1}),b.value>0?(n(),c("div",Ve,[l(t(Q),{page:z.value,"onUpdate:page":e[0]||(e[0]=a=>z.value=a),"item-count":b.value,"page-size":C.value,"show-size-picker":"","page-sizes":[6,12,18],"onUpdate:pageSize":e[1]||(e[1]=a=>C.value=a)},null,8,["page","item-count","page-size"])])):x("",!0)])):x("",!0)])):g.value==="practice"?(n(),c("div",$e,[s("div",Be,[l(t(A),{secondary:"",onClick:Y},{icon:i(()=>[l(t(w),{component:t(ue)},null,8,["component"])]),default:i(()=>[e[8]||(e[8]=d(" 重选话题",-1))]),_:1})]),l(t($),{"x-gap":"24",cols:"1 800:2",responsive:"screen"},{default:i(()=>[l(t(U),null,{default:i(()=>[l(t(P),{class:"topic-card",title:"Speaking Topic",bordered:!1},{default:i(()=>[s("h2",He,r(_.value.title),1),s("div",Me,r(_.value.question),1),s("div",je,[e[9]||(e[9]=s("div",{class:"text-gray-400 mb-2 text-sm"},"KEYWORDS & TIPS",-1)),l(t(W),null,{default:i(()=>[(n(!0),c(N,null,R(_.value.keywords,a=>(n(),D(t(I),{key:a,size:"small",bordered:!1,type:"info"},{default:i(()=>[d(r(a),1)]),_:2},1024))),128)),(n(!0),c(N,null,R(_.value.tips,a=>(n(),D(t(I),{key:a,size:"small",bordered:!1,type:"warning"},{default:i(()=>[d(r(a),1)]),_:2},1024))),128))]),_:1})])]),_:1})]),_:1}),l(t(U),null,{default:i(()=>[l(t(P),{class:"recorder-card",bordered:!1},{default:i(()=>[s("div",qe,[s("div",{class:K(["visualizer-circle mb-8",{active:f.value}])},[l(t(w),{component:t(de),size:"48",color:"white"},null,8,["component"]),f.value?(n(),c("div",Oe)):x("",!0),f.value?(n(),c("div",Ge)):x("",!0)],2),s("div",Ye,r(le(h.value)),1),s("div",Je,[l(t(A),{circle:"",size:"large",style:{width:"80px",height:"80px"},type:f.value?"error":"primary",onClick:se},{icon:i(()=>[l(t(w),{component:f.value?t(pe):t(ve),size:"40"},null,8,["component"])]),_:1},8,["type"])]),s("div",Ke,r(y.value||"Click microphone to start speaking..."),1),s("div",Qe,[l(t(A),{type:"success",block:"",size:"large",disabled:!y.value&&h.value<2,onClick:oe,loading:S.value},{default:i(()=>[...e[10]||(e[10]=[d(" 完成并评估 ",-1)])]),_:1},8,["disabled","loading"])])])]),_:1})]),_:1})]),_:1})])):g.value==="result"?(n(),c("div",We,[l(t(P),{class:"score-card",bordered:!1},{default:i(()=>[l(t(be),{status:"success",title:"Evaluation Complete",description:"Overall Score: "+u.value.score},{footer:i(()=>[l(t(W),{justify:"center",size:"large"},{default:i(()=>[s("div",Xe,[l(t(B),{type:"circle",percentage:u.value.fluency,color:"#6366f1",width:80},{default:i(()=>[e[11]||(e[11]=s("span",{class:"text-xs text-gray-400"},"Fluency",-1)),e[12]||(e[12]=s("br",null,null,-1)),s("span",Ze,r(u.value.fluency),1)]),_:1},8,["percentage"])]),s("div",et,[l(t(B),{type:"circle",percentage:u.value.vocabulary,color:"#10b981",width:80},{default:i(()=>[e[13]||(e[13]=s("span",{class:"text-xs text-gray-400"},"Vocab",-1)),e[14]||(e[14]=s("br",null,null,-1)),s("span",tt,r(u.value.vocabulary),1)]),_:1},8,["percentage"])]),s("div",st,[l(t(B),{type:"circle",percentage:u.value.grammar,color:"#f59e0b",width:80},{default:i(()=>[e[15]||(e[15]=s("span",{class:"text-xs text-gray-400"},"Grammar",-1)),e[16]||(e[16]=s("br",null,null,-1)),s("span",at,r(u.value.grammar),1)]),_:1},8,["percentage"])])]),_:1})]),_:1},8,["description"])]),_:1}),l(t(P),{title:"Detailed Feedback",class:"mt-6",bordered:!1},{default:i(()=>[s("div",lt,r(u.value.feedback),1),s("h3",ot,[l(t(w),{component:t(ge)},null,8,["component"]),e[17]||(e[17]=d(" Suggestions",-1))]),l(t(xe),null,{default:i(()=>[(n(!0),c(N,null,R(u.value.suggestions,(a,T)=>(n(),D(t(ke),{key:T},{default:i(()=>[d(r(a),1)]),_:2},1024))),128))]),_:1}),s("div",it,[l(t(A),{type:"primary",size:"large",onClick:Y},{default:i(()=>[...e[18]||(e[18]=[d("Practice Another Topic",-1)])]),_:1})])]),_:1}),b.value>0?(n(),c("div",nt,[s("div",rt,[l(t(w),{component:t(J)},null,8,["component"]),e[19]||(e[19]=d(" 最近生成话题 ",-1))]),l(t($),{"x-gap":"20","y-gap":"20",cols:"1 600:2 1200:3"},{default:i(()=>[(n(!0),c(N,null,R(H.value,a=>(n(),D(t(U),{key:a.id},{default:i(()=>[s("div",{class:"history-card",onClick:T=>j(a)},[s("div",ut,[l(t(I),{size:"small",type:"warning",bordered:!1},{default:i(()=>[d(r(a.type),1)]),_:2},1024),l(t(I),{size:"tiny",bordered:!1},{default:i(()=>[d(r(a.difficulty),1)]),_:2},1024)]),s("h4",dt,r(a.topic),1)],8,ct)]),_:2},1024))),128))]),_:1}),b.value>0?(n(),c("div",pt,[l(t(Q),{page:z.value,"onUpdate:page":e[2]||(e[2]=a=>z.value=a),"item-count":b.value,"page-size":C.value,"show-size-picker":"","page-sizes":[6,12,18],"onUpdate:pageSize":e[3]||(e[3]=a=>C.value=a)},null,8,["page","item-count","page-size"])])):x("",!0)])):x("",!0)])):x("",!0)]))}},bt=ne(vt,[["__scopeId","data-v-ca17b242"]]);export{bt as default};
