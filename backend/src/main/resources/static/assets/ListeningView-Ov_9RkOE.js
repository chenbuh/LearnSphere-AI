import{a as R}from"./ai-CYMBpxnS.js";import{_ as fe,af as ge,r as g,V as N,o as ye,bm as _e,aN as K,bp as x,g as d,b as c,e as a,d as n,w as o,u as l,a3 as W,y as B,F as k,x as w,n as j,t as u,am as V,i as C,j as h,c as X,k as he,f as U,z as me,D as be,ad as G,bn as ke,a2 as we,al as Ce,aj as Ne}from"./index-DxUHCA-q.js";import{H as qe}from"./history-DU2rBN7r.js";import{A as Se}from"./arrow-left-DlNknngt.js";import{C as ze}from"./circle-stop-ChkWTsNT.js";import{C as Pe}from"./circle-play-BNF1hpSe.js";import{N as Le}from"./Thing-C1BPltNf.js";import{N as Ae}from"./Result-BjByxIDK.js";const Te={class:"listening-view"},$e={key:0,class:"setup-container"},xe={class:"config-item"},Be={class:"type-grid"},Ve=["onClick"],Ee={class:"icon"},Me={class:"label"},Qe={class:"config-item"},je={class:"config-item"},De={key:0,class:"empty-history"},He={key:2,class:"pagination-wrapper mt-4"},Ue={key:1,class:"test-container"},Ge={class:"test-header"},Fe={class:"passage-title"},Oe={class:"timer-box"},Je={class:"count"},Ie={class:"test-layout"},Re={class:"main-content"},Ke={class:"play-btn"},We={class:"audio-info"},Xe={class:"question-header"},Ye={class:"q-num"},Ze={class:"options-grid"},et=["onClick"],tt={class:"option-idx"},st={class:"option-text"},at={class:"nav-actions"},lt={class:"side-navigation"},nt={class:"group-title"},ot={class:"num-grid"},it=["onClick"],ut={key:2,class:"result-container"},rt={class:"score-circle"},ct={class:"val"},dt={__name:"ListeningView",setup(vt){const S=ge(),m=g("setup"),z=g(!1),v=g([]),r=g(0),p=g(0),y=g({}),E=g(0),P=g([]),b=g(!1),D=g(1),q=g(10),_=g({examType:"ted",mode:"extensive",difficulty:"normal",count:3}),Y=[{label:"TED æ¼”è®²",value:"ted",icon:"ğŸ¤"},{label:"BBC æ–°é—»",value:"bbc",icon:"ğŸŒ"},{label:"æ—¥å¸¸å¯¹è¯",value:"dialog",icon:"ğŸ’¬"},{label:"æ‰˜ç¦å¬åŠ›",value:"toefl",icon:"ğŸ—½"},{label:"é›…æ€å¬åŠ›",value:"ielts",icon:"ğŸ‡¬ğŸ‡§"},{label:"è‹±è¯­æ•…äº‹",value:"stories",icon:"ğŸ“–"}],Z=[{label:"æ…¢é€Ÿ",value:"slow"},{label:"æ ‡å‡†",value:"normal"},{label:"å¿«é€Ÿ",value:"fast"}],ee=[3,5,8,10],L=N(()=>v.value[r.value]||null),F=N(()=>{const e=L.value;return!e||!e.questions?null:e.questions[p.value]}),M=N(()=>v.value.reduce((e,t)=>e+(t.questions?.length||0),0)),Q=N(()=>{let e=0;for(let t=0;t<r.value;t++)e+=v.value[t]?.questions?.length||0;return e+p.value}),te=N(()=>M.value===0?0:(Q.value+1)/M.value*100),se=N(()=>m.value==="testing"&&Object.keys(y.value).length>0),ae=N(()=>{const e=(D.value-1)*q.value,t=e+q.value;return P.value.slice(e,t)}),O=e=>{if(se.value)return e.preventDefault(),e.returnValue="ç»ƒä¹ æ­£åœ¨è¿›è¡Œä¸­ï¼Œç¦»å¼€å°†ä¸¢å¤±è¿›åº¦ã€‚",e.returnValue};ye(()=>{J(),window.addEventListener("beforeunload",O)}),_e(()=>{window.removeEventListener("beforeunload",O),A()}),K(r,()=>{A()});const J=async()=>{try{const e=await R.getListeningHistory();e.code===200&&(P.value=e.data||[])}catch(e){x.error("Failed to fetch history",e)}},le=e=>{if(e)try{let t=e.questions;if(typeof t=="string")try{t=JSON.parse(t)}catch(s){x.error("Failed to parse questions JSON",s),t=[]}v.value=[{id:e.id||Date.now(),title:e.title||"Historical Material",script:e.script||"",questions:Array.isArray(t)?t:[]}],r.value=0,p.value=0,y.value={0:{}},m.value="testing",S.success(`å·²é‡æ–°åŠ è½½: ${e.title}`)}catch(t){S.error("åŠ è½½å†å²æ•°æ®å¤±è´¥"),x.error("Load Material Error",t)}},ne=async()=>{z.value=!0;try{const e=await R.generateListening({type:_.value.examType,difficulty:_.value.difficulty,count:_.value.count});e.code===200&&e.data&&(e.data.passages?v.value=e.data.passages:v.value=[{id:1,title:e.data.title||"Passage 1",script:e.data.script||"",questions:e.data.questions||[]}],r.value=0,p.value=0,y.value={},v.value.forEach((t,s)=>{y.value[s]={}}),m.value="testing",S.success(`å¬åŠ›ç”ŸæˆæˆåŠŸï¼šå…± ${v.value.length} ç¯‡`),J())}catch(e){x.error("Generation Error",e),S.error("ç”Ÿæˆå¤±è´¥")}finally{z.value=!1}},oe=()=>{const e=L.value;if(!(!e||!e.script)&&"speechSynthesis"in window){window.speechSynthesis.cancel();const t=new SpeechSynthesisUtterance(e.script);t.lang="en-US",t.rate=_.value.difficulty==="slow"?.8:_.value.difficulty==="fast"?1.2:1,t.onstart=()=>{b.value=!0},t.onend=()=>{b.value=!1},t.onerror=()=>{b.value=!1},window.speechSynthesis.speak(t)}},A=()=>{"speechSynthesis"in window&&window.speechSynthesis.cancel(),b.value=!1},ie=e=>{y.value[r.value]||(y.value[r.value]={}),y.value[r.value][p.value]=e},ue=()=>{const e=L.value;e&&(p.value<e.questions.length-1?p.value++:r.value<v.value.length-1?(r.value++,p.value=0,S.info(`è¿›å…¥ä¸‹ä¸€ç¯‡: ${L.value.title}`)):de())},re=()=>{if(p.value>0)p.value--;else if(r.value>0){r.value--;const e=v.value[r.value];p.value=(e.questions?.length||1)-1}},ce=(e,t)=>{r.value=e,p.value=t},de=async()=>{z.value=!0;try{let e=0,t=0;for(let s=0;s<v.value.length;s++){const i=v.value[s],T=y.value[s]||{};for(let f=0;f<i.questions.length;f++){const $=i.questions[f],H=T[f]===$.correct;H&&e++,t++,await Ne.createRecord({contentId:$.id||s*100+f,contentType:"listening",isCorrect:H?1:0,answer:T[f]!==void 0?String(T[f]):"-1",correctAnswer:String($.correct),masteryLevel:H?3:1,originalContent:JSON.stringify({passage:i.title,question:$.question,script:i.script})}).catch(pe=>x.error("Save error",pe))}}E.value=t>0?Math.round(e/t*100):0,m.value="result"}finally{z.value=!1}},I=()=>{A(),m.value="setup",v.value=[],y.value={}};K(m,e=>{e!=="testing"&&A()});const ve=(e,t)=>{let s=1;for(let i=0;i<e;i++)s+=v.value[i].questions?.length||0;return s+t};return(e,t)=>(c(),d("div",Te,[m.value==="setup"?(c(),d("div",$e,[t[8]||(t[8]=a("div",{class:"hero-section"},[a("h1",null,"AI å¬åŠ›ç‰¹è®­"),a("p",null,"åŸºäºå…ˆè¿› AI æŠ€æœ¯çš„æ²‰æµ¸å¼è‹±è¯­å¬åŠ›ç¯å¢ƒ")],-1)),n(l(we),{"x-gap":"24","y-gap":"24",cols:"1 700:2",responsive:"screen"},{default:o(()=>[n(l(W),{span:"1"},{default:o(()=>[n(l(B),{class:"config-card",title:"é…ç½®æ‚¨çš„ç”Ÿæˆæ–¹æ¡ˆ",bordered:!1},{footer:o(()=>[n(l(C),{type:"primary",block:"",size:"large",loading:z.value,onClick:ne},{default:o(()=>[...t[6]||(t[6]=[h(" ç”Ÿæˆå¬åŠ›ææ–™ ",-1)])]),_:1},8,["loading"])]),default:o(()=>[a("div",xe,[t[3]||(t[3]=a("label",null,"ææ–™ç±»å‹",-1)),a("div",Be,[(c(),d(k,null,w(Y,s=>a("div",{key:s.value,class:j(["type-btn",{active:_.value.examType===s.value}]),onClick:i=>_.value.examType=s.value},[a("span",Ee,u(s.icon),1),a("span",Me,u(s.label),1)],10,Ve)),64))])]),a("div",Qe,[t[4]||(t[4]=a("label",null,"ç¯‡ç« æ•°é‡",-1)),n(l(V),null,{default:o(()=>[(c(),d(k,null,w(ee,s=>n(l(C),{key:s,size:"small",type:_.value.count===s?"primary":"default",onClick:i=>_.value.count=s},{default:o(()=>[h(u(s)+" ç¯‡ ",1)]),_:2},1032,["type","onClick"])),64))]),_:1})]),a("div",je,[t[5]||(t[5]=a("label",null,"è¯­é€Ÿæ§åˆ¶",-1)),n(l(V),null,{default:o(()=>[(c(),d(k,null,w(Z,s=>n(l(C),{key:s.value,size:"small",type:_.value.difficulty===s.value?"primary":"default",onClick:i=>_.value.difficulty=s.value},{default:o(()=>[h(u(s.label),1)]),_:2},1032,["type","onClick"])),64))]),_:1})])]),_:1})]),_:1}),n(l(W),{span:"1"},{default:o(()=>[n(l(B),{class:"history-card",title:"ç”Ÿæˆè®°å½•",bordered:!1},{default:o(()=>[P.value.length===0?(c(),d("div",De,[n(l(U),{component:l(qe),size:"40"},null,8,["component"]),t[7]||(t[7]=a("p",null,"æš‚æ— å†å²çºªå½•",-1))])):(c(),X(l(me),{key:1,hoverable:"",clickable:""},{default:o(()=>[(c(!0),d(k,null,w(ae.value,s=>(c(),X(l(be),{key:s.id,onClick:i=>le(s),style:{cursor:"pointer"}},{default:o(()=>[n(l(Le),{title:s.title},{description:o(()=>[n(l(V),null,{default:o(()=>[n(l(G),{size:"small",type:"info",bordered:!1},{default:o(()=>[h(u(s.type),1)]),_:2},1024),n(l(G),{size:"small",type:"success",bordered:!1},{default:o(()=>[h(u(s.difficulty),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["title"])]),_:2},1032,["onClick"]))),128))]),_:1})),P.value.length>q.value?(c(),d("div",He,[n(l(ke),{page:D.value,"onUpdate:page":t[0]||(t[0]=s=>D.value=s),"page-count":Math.ceil(P.value.length/q.value),"page-size":q.value,"show-size-picker":"","page-sizes":[10,20,30],"onUpdate:pageSize":t[1]||(t[1]=s=>q.value=s)},null,8,["page","page-count","page-size"])])):he("",!0)]),_:1})]),_:1})]),_:1})])):m.value==="testing"?(c(),d("div",Ue,[a("div",Ge,[n(l(C),{quaternary:"",circle:"",onClick:I},{icon:o(()=>[n(l(U),{component:l(Se)},null,8,["component"])]),_:1}),a("div",Fe,[a("h2",null,u(L.value?.title),1),n(l(G),{size:"small",type:"primary"},{default:o(()=>[h("Passage "+u(r.value+1)+" / "+u(v.value.length),1)]),_:1})]),a("div",Oe,[n(l(Ce),{type:"circle",percentage:te.value,"show-indicator":!1,width:40},null,8,["percentage"]),a("span",Je,u(Q.value+1)+" / "+u(M.value),1)])]),a("div",Ie,[a("div",Re,[a("div",{class:"audio-block",onClick:t[2]||(t[2]=s=>b.value?A():oe())},[a("div",{class:j(["playback-visualizer",{isPlaying:b.value}])},[(c(),d(k,null,w(8,s=>a("div",{key:s,class:"bar"})),64))],2),a("div",Ke,[n(l(U),{component:b.value?l(ze):l(Pe),size:"48"},null,8,["component"])]),a("div",We,[a("h4",null,u(b.value?"éŸ³é¢‘æ’­æ”¾ä¸­...":"ç‚¹å‡»æ’­æ”¾å½“å‰ç¯‡ç« éŸ³é¢‘"),1),a("p",null,"Passage "+u(r.value+1)+" æ­£åœ¨æœ—è¯»",1)])]),n(l(B),{class:"question-card",bordered:!1},{default:o(()=>[a("div",Xe,[a("span",Ye,"Question "+u(Q.value+1),1),a("h3",null,u(F.value?.question),1)]),a("div",Ze,[(c(!0),d(k,null,w(F.value?.options,(s,i)=>(c(),d("div",{key:i,class:j(["option-item",{selected:y.value[r.value]?.[p.value]===i}]),onClick:T=>ie(i)},[a("span",tt,u(String.fromCharCode(65+i)),1),a("span",st,u(s),1)],10,et))),128))]),a("div",at,[n(l(V),{justify:"space-between",style:{width:"100%"}},{default:o(()=>[n(l(C),{secondary:"",onClick:re,disabled:r.value===0&&p.value===0},{default:o(()=>[...t[9]||(t[9]=[h(" ä¸Šä¸€é¢˜ ",-1)])]),_:1},8,["disabled"]),n(l(C),{type:"primary",onClick:ue},{default:o(()=>[h(u(Q.value===M.value-1?"æäº¤è¯•å·":"ä¸‹ä¸€é¢˜"),1)]),_:1})]),_:1})])]),_:1})]),a("div",lt,[n(l(B),{title:"é¢˜ç›®å¯¼èˆª",bordered:!1,size:"small"},{default:o(()=>[(c(!0),d(k,null,w(v.value,(s,i)=>(c(),d("div",{key:i,class:"nav-group"},[a("div",nt,"Passage "+u(i+1),1),a("div",ot,[(c(!0),d(k,null,w(s.questions,(T,f)=>(c(),d("div",{key:f,class:j(["num-box",{active:i===r.value&&f===p.value,answered:y.value[i]?.[f]!==void 0}]),onClick:$=>ce(i,f)},u(ve(i,f)),11,it))),128))])]))),128))]),_:1})])])])):(c(),d("div",ut,[n(l(B),{class:"result-card",bordered:!1},{default:o(()=>[n(l(Ae),{status:"success",title:`ç»ƒä¹ å·²å®Œæˆ! å¾—åˆ†: ${E.value}`,description:E.value>=60?"è¡¨ç°ä¸é”™ï¼Œç»§ç»­ä¿æŒï¼":"è¿˜éœ€è¦å¤šåŠ ç»ƒä¹ ï¼ŒåŠ æ²¹ï¼"},{icon:o(()=>[a("div",rt,[a("span",ct,u(E.value),1)])]),footer:o(()=>[n(l(V),{justify:"center"},{default:o(()=>[n(l(C),{type:"primary",onClick:I},{default:o(()=>[...t[10]||(t[10]=[h("é‡æ–°å¼€å§‹é¡¹ç›®",-1)])]),_:1}),n(l(C),{secondary:""},{default:o(()=>[...t[11]||(t[11]=[h("æŸ¥çœ‹è¯¦ç»†è§£æ",-1)])]),_:1})]),_:1})]),_:1},8,["title","description"])]),_:1})]))]))}},kt=fe(dt,[["__scopeId","data-v-ee4e18e5"]]);export{kt as default};
