<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”™é¢˜æœ¬é‡ç½®åŠŸèƒ½è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .debug-section {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        .success {
            border-left-color: #28a745;
            background: #f0fff4;
        }
        .warning {
            border-left-color: #ffc107;
            background: #fffbf0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .danger {
            background: #dc3545;
        }
        .danger:hover {
            background: #c82333;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        .log {
            max-height: 300px;
            overflow-y: auto;
            background: #000;
            color: #0f0;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ é”™é¢˜æœ¬é‡ç½®åŠŸèƒ½è°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-section warning">
        <h3>âš ï¸ ä½¿ç”¨è¯´æ˜</h3>
        <p>è¿™ä¸ªè°ƒè¯•å·¥å…·å¯ä»¥å¸®åŠ©è¯Šæ–­å’Œä¿®å¤é”™é¢˜æœ¬é‡ç½®åŠŸèƒ½çš„é—®é¢˜ã€‚è¯·æŒ‰é¡ºåºæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
    </div>

    <div class="debug-section">
        <h3>ğŸ“‹ æ­¥éª¤1: ç³»ç»Ÿæ£€æŸ¥</h3>
        <button onclick="checkSystem()">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
        <div id="systemStatus"></div>
    </div>

    <div class="debug-section">
        <h3>ğŸ”§ æ­¥éª¤2: æ‰‹åŠ¨é‡ç½®</h3>
        <p>å¦‚æœè‡ªåŠ¨é‡ç½®ä¸å·¥ä½œï¼Œå¯ä»¥å°è¯•æ‰‹åŠ¨é‡ç½®ï¼š</p>
        <button onclick="manualReset()" class="danger">æ‰‹åŠ¨é‡ç½®é”™é¢˜æœ¬</button>
        <button onclick="createTestData()">åˆ›å»ºæµ‹è¯•æ•°æ®</button>
        <div id="resetStatus"></div>
    </div>

    <div class="debug-section">
        <h3>ğŸ“Š æ­¥éª¤3: éªŒè¯ç»“æœ</h3>
        <button onclick="checkStats()">æ£€æŸ¥é”™é¢˜ç»Ÿè®¡</button>
        <button onclick="refreshPage()">åˆ·æ–°é¡µé¢</button>
        <div id="statsDisplay"></div>
    </div>

    <div class="debug-section">
        <h3>ğŸ“ è°ƒè¯•æ—¥å¿—</h3>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="debugLog" class="log"></div>
    </div>

    <script>
        let logElement = document.getElementById('debugLog');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : type === 'warning' ? '#ff0' : '#0f0';
            logElement.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            logElement.innerHTML = '';
        }

        async function checkSystem() {
            log('ğŸ” å¼€å§‹ç³»ç»Ÿæ£€æŸ¥...', 'info');
            const statusDiv = document.getElementById('systemStatus');
            let html = '<h4>ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ç»“æœï¼š</h4>';
            
            try {
                // æ£€æŸ¥æ˜¯å¦åœ¨LearnSphereé¡µé¢
                const isLearnSphere = window.location.href.includes('LearnSphere') || 
                                    document.title.includes('LearnSphere') ||
                                    document.querySelector('[data-app="learnsphere"]');
                
                html += `<p>ğŸ“ LearnSphereåº”ç”¨: ${isLearnSphere ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>`;
                
                if (!isLearnSphere) {
                    html += '<p class="error">âš ï¸ è¯·åœ¨LearnSphereåº”ç”¨ä¸­ä½¿ç”¨æ­¤å·¥å…·</p>';
                    statusDiv.innerHTML = html;
                    return;
                }

                // æ£€æŸ¥é”™é¢˜æœ¬ç®¡ç†å™¨
                const hasErrorBookManager = !!(window.errorBookManager);
                html += `<p>ğŸ“š é”™é¢˜æœ¬ç®¡ç†å™¨: ${hasErrorBookManager ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}</p>`;
                
                if (hasErrorBookManager) {
                    const stats = window.errorBookManager.getErrorStats();
                    html += `<p>ğŸ“Š å½“å‰é”™é¢˜æ•°é‡: ${stats.totalErrors}</p>`;
                    html += `<p>ğŸ“ˆ å·²æŒæ¡: ${stats.masteredErrors}</p>`;
                    html += `<p>â° å¾…å¤ä¹ : ${stats.needReview}</p>`;
                    log(`å½“å‰é”™é¢˜ç»Ÿè®¡: ${JSON.stringify(stats)}`, 'info');
                }

                // æ£€æŸ¥åº”ç”¨å¯¹è±¡
                const hasApp = !!(window.app);
                html += `<p>ğŸ”§ åº”ç”¨å¯¹è±¡: ${hasApp ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}</p>`;
                
                if (hasApp) {
                    const hasResetMethod = typeof window.app.resetErrorBook === 'function';
                    html += `<p>ğŸ”„ é‡ç½®æ–¹æ³•: ${hasResetMethod ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}</p>`;
                }

                // æ£€æŸ¥é‡ç½®æŒ‰é’®
                const resetBtn = document.getElementById('resetErrorBookBtn');
                html += `<p>ğŸ”˜ é‡ç½®æŒ‰é’®: ${resetBtn ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}</p>`;
                
                if (resetBtn) {
                    const isVisible = resetBtn.offsetParent !== null;
                    html += `<p>ğŸ‘ï¸ æŒ‰é’®å¯è§: ${isVisible ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>`;
                }

                log('âœ… ç³»ç»Ÿæ£€æŸ¥å®Œæˆ', 'success');
                
            } catch (error) {
                html += `<p class="error">âŒ æ£€æŸ¥è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}</p>`;
                log(`ç³»ç»Ÿæ£€æŸ¥é”™è¯¯: ${error.message}`, 'error');
            }
            
            statusDiv.innerHTML = html;
        }

        async function manualReset() {
            log('ğŸ”„ å¼€å§‹æ‰‹åŠ¨é‡ç½®é”™é¢˜æœ¬...', 'info');
            const statusDiv = document.getElementById('resetStatus');
            
            try {
                // æ£€æŸ¥é”™é¢˜æœ¬ç®¡ç†å™¨
                if (!window.errorBookManager) {
                    throw new Error('é”™é¢˜æœ¬ç®¡ç†å™¨æœªåˆå§‹åŒ–');
                }

                // è·å–é‡ç½®å‰çš„ç»Ÿè®¡
                const beforeStats = window.errorBookManager.getErrorStats();
                log(`é‡ç½®å‰ç»Ÿè®¡: é”™é¢˜${beforeStats.totalErrors}ä¸ª, å·²æŒæ¡${beforeStats.masteredErrors}ä¸ª`, 'info');

                // æ‰§è¡Œé‡ç½®
                const clearedCount = window.errorBookManager.clearAllErrors();
                log(`å·²æ¸…ç©º ${clearedCount} ä¸ªé”™é¢˜è®°å½•`, 'success');

                // æ›´æ–°ç•Œé¢ç»Ÿè®¡ï¼ˆå¦‚æœå¯èƒ½ï¼‰
                if (window.app && typeof window.app.updateErrorBookStats === 'function') {
                    await window.app.updateErrorBookStats();
                    log('ç•Œé¢ç»Ÿè®¡å·²æ›´æ–°', 'success');
                }

                // æ˜¾ç¤ºå¼•å¯¼ä¿¡æ¯ï¼ˆå¦‚æœå¯èƒ½ï¼‰
                if (window.app && typeof window.app.showErrorBookGuidance === 'function') {
                    window.app.showErrorBookGuidance();
                    log('å¼•å¯¼ä¿¡æ¯å·²æ˜¾ç¤º', 'success');
                }

                // éªŒè¯é‡ç½®ç»“æœ
                const afterStats = window.errorBookManager.getErrorStats();
                log(`é‡ç½®åç»Ÿè®¡: é”™é¢˜${afterStats.totalErrors}ä¸ª, å·²æŒæ¡${afterStats.masteredErrors}ä¸ª`, 'info');

                statusDiv.innerHTML = `
                    <div class="success">
                        <h4>âœ… æ‰‹åŠ¨é‡ç½®æˆåŠŸï¼</h4>
                        <p>å·²æ¸…ç©º ${clearedCount} ä¸ªé”™é¢˜è®°å½•</p>
                        <p>å½“å‰é”™é¢˜æ•°é‡: ${afterStats.totalErrors}</p>
                    </div>
                `;

                log('âœ… æ‰‹åŠ¨é‡ç½®å®Œæˆ', 'success');

            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ æ‰‹åŠ¨é‡ç½®å¤±è´¥</h4>
                        <p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                    </div>
                `;
                log(`æ‰‹åŠ¨é‡ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function createTestData() {
            log('ğŸ“ åˆ›å»ºæµ‹è¯•æ•°æ®...', 'info');
            
            try {
                if (!window.errorBookManager) {
                    throw new Error('é”™é¢˜æœ¬ç®¡ç†å™¨æœªåˆå§‹åŒ–');
                }

                // åˆ›å»ºæµ‹è¯•é”™é¢˜
                const testErrors = [
                    {
                        module: 'vocabulary',
                        category: 'è¯æ±‡å­¦ä¹ ',
                        knowledgePoint: 'meaning',
                        question: 'æµ‹è¯•é¢˜ç›®1ï¼šWhat does "example" mean?',
                        userAnswer: 'é”™è¯¯ç­”æ¡ˆ1',
                        correctAnswer: 'ä¾‹å­ï¼Œç¤ºä¾‹',
                        explanation: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è§£æ1',
                        difficulty: 'medium'
                    },
                    {
                        module: 'grammar',
                        category: 'è¯­æ³•ç»ƒä¹ ',
                        knowledgePoint: 'tenses',
                        question: 'æµ‹è¯•é¢˜ç›®2ï¼šChoose the correct tense.',
                        userAnswer: 'é”™è¯¯ç­”æ¡ˆ2',
                        correctAnswer: 'æ­£ç¡®ç­”æ¡ˆ2',
                        explanation: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è§£æ2',
                        difficulty: 'easy'
                    }
                ];

                testErrors.forEach((errorData, index) => {
                    window.errorBookManager.recordError(errorData);
                    log(`å·²åˆ›å»ºæµ‹è¯•é”™é¢˜ ${index + 1}`, 'success');
                });

                const stats = window.errorBookManager.getErrorStats();
                log(`æµ‹è¯•æ•°æ®åˆ›å»ºå®Œæˆï¼Œå½“å‰é”™é¢˜æ•°é‡: ${stats.totalErrors}`, 'success');

            } catch (error) {
                log(`åˆ›å»ºæµ‹è¯•æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function checkStats() {
            log('ğŸ“Š æ£€æŸ¥é”™é¢˜ç»Ÿè®¡...', 'info');
            const statsDiv = document.getElementById('statsDisplay');
            
            try {
                if (!window.errorBookManager) {
                    throw new Error('é”™é¢˜æœ¬ç®¡ç†å™¨æœªåˆå§‹åŒ–');
                }

                const stats = window.errorBookManager.getErrorStats();
                log(`å½“å‰ç»Ÿè®¡: ${JSON.stringify(stats)}`, 'info');

                statsDiv.innerHTML = `
                    <h4>ğŸ“Š å½“å‰é”™é¢˜ç»Ÿè®¡ï¼š</h4>
                    <ul>
                        <li>ç´¯è®¡é”™é¢˜: ${stats.totalErrors}</li>
                        <li>å·²æŒæ¡: ${stats.masteredErrors}</li>
                        <li>å¾…å¤ä¹ : ${stats.needReview}</li>
                        <li>æŒæ¡ç‡: ${stats.masteryRate}%</li>
                    </ul>
                `;

            } catch (error) {
                statsDiv.innerHTML = `<p class="error">è·å–ç»Ÿè®¡å¤±è´¥: ${error.message}</p>`;
                log(`è·å–ç»Ÿè®¡å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function refreshPage() {
            log('ğŸ”„ åˆ·æ–°é¡µé¢...', 'info');
            window.location.reload();
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç³»ç»Ÿ
        window.addEventListener('load', () => {
            log('ğŸš€ è°ƒè¯•å·¥å…·å·²åŠ è½½', 'info');
            setTimeout(checkSystem, 1000);
        });
    </script>
</body>
</html>
